<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangkok Trip 2025-26 (Collab)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'DM Sans', 'Noto Sans TC', sans-serif;
            background-color: #F0F4F8;
            color: #334155;
        }
        
        /* Ê∂≤ÊÖãËÉåÊôØÂãïÁï´ */
        @keyframes float {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.6;
            z-index: 0;
            animation: float 10s infinite ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #B4C5D4; animation-delay: 0s; }
        .blob-2 { bottom: 10%; right: -5%; width: 250px; height: 250px; background: #D8C8C0; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 30%; width: 200px; height: 200px; background: #C4D4C4; animation-delay: 4s; }

        /* Ê∂≤ÊÖãÁéªÁíÉÂç°Áâá */
        .glass-card {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        
        /* ÁïôË®ÄÊ∞£Ê≥°ÂãïÁï´ */
        .comment-enter-active, .comment-leave-active { transition: all 0.2s ease; }
        .comment-enter-from, .comment-leave-to { opacity: 0; transform: translateY(-10px); }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#E8EEF2]">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto shadow-2xl relative overflow-hidden bg-[#F2F5F8]/80">
        
        <!-- Background Blobs -->
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>

        <!-- Header -->
        <header class="pt-10 pb-4 px-6 flex justify-between items-start z-10 glass-header">
            <div>
                <h1 class="text-4xl italic text-[#5D6F80] tracking-wide" style="font-family: 'Playfair Display', serif;">Bangkok</h1>
                <p class="text-[10px] text-[#788998] tracking-[0.3em] mt-1 font-bold uppercase">Journey Log 2025-26</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                 <!-- User Profile / Switcher -->
                 <button @click="showUserModal = true" class="flex items-center gap-2 bg-white/40 pl-3 pr-1 py-1 rounded-full backdrop-blur-sm border border-white/50 hover:bg-white/60 transition-all shadow-sm">
                    <span class="text-xs font-bold text-[#5D6F80] truncate max-w-[60px]">{{ currentUser.name }}</span>
                    <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm shadow-sm" :class="currentUser.bgColor || 'bg-slate-200'">
                        {{ currentUser.avatar }}
                    </div>
                </button>
                <!-- Share Button -->
                <button @click="openShareModal" class="p-2 rounded-full bg-slate-200/50 text-[#5D6F80] hover:bg-slate-300/50 transition-colors">
                    <i data-lucide="share-2" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <!-- Date Selector -->
        <div v-if="currentTab === 'trip'" class="pl-6 mb-4 mt-4 z-10 relative">
            <div class="flex gap-3 overflow-x-auto scrollbar-hide pr-6 pb-4">
                <button 
                    v-for="date in dates" 
                    :key="date.fullDate"
                    @click="selectedDate = date.fullDate"
                    :class="getDateButtonClass(date)"
                    class="flex-shrink-0 w-[4.2rem] h-[5.5rem] rounded-[20px] flex flex-col items-center justify-center transition-all duration-300 border backdrop-blur-md shadow-sm"
                >
                    <span class="text-[10px] font-bold mb-1 opacity-70">{{ date.monthStr }}</span>
                    <span class="text-xl font-bold mb-1 font-serif">{{ date.dayNum }}</span>
                    <span class="text-[10px] tracking-widest font-bold">{{ date.weekDay }}</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto px-4 pb-28 scrollbar-hide relative z-10">
            
            <!-- TRIP TAB -->
            <div v-if="currentTab === 'trip'" class="space-y-4">
                
                <!-- Info Header -->
                <div class="glass-card rounded-2xl p-4 flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100/50 p-2 rounded-full text-[#5D6F80]">
                            <i data-lucide="building-2" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Accommodation</p>
                            <p class="text-xs font-bold text-slate-700 truncate w-48">PARKROYAL Serviced Suites</p>
                        </div>
                    </div>
                     <!-- Weather Widget -->
                    <div class="flex flex-col items-end" v-if="weatherData[selectedDate]">
                        <div class="flex items-center gap-1">
                            <i :data-lucide="getWeatherIcon(weatherData[selectedDate].code)" class="w-5 h-5 text-amber-500/80"></i>
                            <span class="text-lg font-bold text-slate-600">{{ weatherData[selectedDate].temp }}¬∞</span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-if="currentDayEvents.length === 0" class="text-center py-12 opacity-50">
                    <p class="font-serif italic text-lg text-slate-500">No plans yet...</p>
                </div>

                <!-- Timeline -->
                <div class="relative space-y-4 pl-2">
                    <!-- Line -->
                    <div class="absolute left-[27px] top-4 bottom-4 w-[1px] bg-slate-300/50 -z-10"></div>

                    <div v-for="event in currentDayEvents" :key="event.id" class="relative group">
                        
                        <!-- Timeline Dot -->
                        <div class="absolute left-0 top-6 w-[54px] flex justify-center z-20">
                            <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(event.type)"></div>
                        </div>

                        <div class="glass-card rounded-[24px] p-4 ml-8 transition-all duration-300 hover:bg-white/60">
                             <!-- Delete Event Button -->
                            <button @click="deleteEvent(event.id)" class="absolute top-4 right-4 text-slate-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>

                            <!-- Event Main Info -->
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-lg font-bold text-[#5D6F80] font-serif">{{ event.time }}</span>
                                <span class="text-[10px] px-2 py-1 rounded-full bg-white/50 text-slate-500 border border-white/60 font-medium tracking-wide">{{ event.typeLabel || 'ACTIVITY' }}</span>
                            </div>
                            
                            <h3 class="text-base font-bold text-slate-700 mb-1 leading-tight">{{ event.title }}</h3>
                            
                            <div v-if="event.desc" class="text-xs text-slate-500 mb-2 leading-relaxed bg-slate-50/30 p-2 rounded-lg border border-white/20">
                                {{ event.desc }}
                            </div>

                            <!-- Actions & Comments Toggle -->
                            <div class="flex items-center justify-between mt-3 pt-2 border-t border-slate-100/50">
                                <div class="flex items-center text-slate-400 text-xs gap-1">
                                    <i data-lucide="map-pin" class="w-3 h-3"></i>
                                    <span class="truncate w-24">{{ event.location }}</span>
                                </div>
                                <div class="flex gap-2">
                                    <!-- Comment Toggle -->
                                    <button @click="toggleComments(event.id)" class="flex items-center gap-1 px-2 py-1.5 rounded-full hover:bg-slate-200/50 transition-colors relative" :class="openCommentId === event.id ? 'bg-slate-200/70 text-[#5D6F80]' : 'text-slate-400'">
                                        <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>
                                        <span v-if="event.comments && event.comments.length > 0" class="text-[10px] font-bold">{{ event.comments.length }}</span>
                                    </button>
                                    
                                    <button @click="editEvent(event)" class="p-1.5 rounded-full bg-slate-200/40 hover:bg-slate-200/70 text-slate-600 transition-colors">
                                        <i data-lucide="edit-3" class="w-3 h-3"></i>
                                    </button>
                                    <a :href="getGoogleMapsLink(event.location)" target="_blank" class="flex items-center gap-1 bg-[#7CA1B3]/20 hover:bg-[#7CA1B3]/40 text-[#5D6F80] text-[10px] font-bold px-3 py-1.5 rounded-full transition-colors backdrop-blur-md">
                                        NAV
                                    </a>
                                </div>
                            </div>

                            <!-- Comment Section (Collapsible) -->
                            <transition name="comment">
                                <div v-if="openCommentId === event.id" class="mt-3 pt-2 bg-white/40 -mx-4 -mb-4 px-4 pb-4 rounded-b-[24px] border-t border-white/50">
                                    <!-- Comment List -->
                                    <div v-if="event.comments && event.comments.length > 0" class="space-y-3 mb-3 max-h-40 overflow-y-auto scrollbar-hide">
                                        <div v-for="comment in event.comments" :key="comment.id" class="flex gap-2 items-start text-xs group/item">
                                            <!-- Avatar -->
                                            <div class="w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] shadow-sm mt-0.5" :class="getUser(comment.userId).bgColor">
                                                {{ getUser(comment.userId).avatar }}
                                            </div>
                                            <!-- Bubble -->
                                            <div class="flex-1">
                                                <div class="flex justify-between items-baseline mb-0.5">
                                                    <span class="font-bold" :class="getUser(comment.userId).textColor">{{ getUser(comment.userId).name }}</span>
                                                    <span class="text-[9px] text-slate-400 scale-90 origin-right">{{ formatTime(comment.timestamp) }}</span>
                                                </div>
                                                
                                                <!-- Edit Mode for Comment -->
                                                <div v-if="editingCommentId === comment.id" class="flex gap-1">
                                                     <input v-model="editingCommentText" class="flex-1 bg-white/80 rounded px-2 py-1 border border-blue-200 text-slate-700 focus:outline-none" @keyup.enter="saveCommentEdit(event, comment)">
                                                     <button @click="saveCommentEdit(event, comment)" class="text-blue-500"><i data-lucide="check" class="w-3 h-3"></i></button>
                                                     <button @click="editingCommentId = null" class="text-slate-400"><i data-lucide="x" class="w-3 h-3"></i></button>
                                                </div>
                                                <div v-else class="text-slate-600 bg-white/60 p-2 rounded-r-xl rounded-bl-xl inline-block shadow-sm relative pr-6 min-w-[60px]">
                                                    {{ comment.text }}
                                                    <!-- Actions (only for own comments) -->
                                                    <div v-if="comment.userId === currentUser.id" class="absolute top-1 right-1 opacity-0 group-hover/item:opacity-100 flex gap-1 bg-white/90 rounded px-1">
                                                        <button @click="startEditComment(comment)" class="text-slate-400 hover:text-blue-500"><i data-lucide="edit-2" class="w-2.5 h-2.5"></i></button>
                                                        <button @click="deleteComment(event, comment.id)" class="text-slate-400 hover:text-red-500"><i data-lucide="trash" class="w-2.5 h-2.5"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-2 text-[10px] text-slate-400 italic">No comments yet. Be the first!</div>

                                    <!-- Add Comment Input -->
                                    <div class="flex gap-2 items-center mt-2">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] opacity-50" :class="currentUser.bgColor">{{ currentUser.avatar }}</div>
                                        <input 
                                            v-model="newCommentTexts[event.id]" 
                                            placeholder="Add a note..." 
                                            class="flex-1 bg-white/70 border-none rounded-full px-3 py-1.5 text-xs focus:ring-1 focus:ring-slate-300 placeholder:text-slate-400"
                                            @keyup.enter="addComment(event)"
                                        >
                                        <button @click="addComment(event)" class="text-[#5D6F80] hover:bg-slate-200 p-1.5 rounded-full"><i data-lucide="send" class="w-3.5 h-3.5"></i></button>
                                    </div>
                                </div>
                            </transition>
                        </div>
                    </div>
                </div>
                
                <div class="h-8"></div>
            </div>

            <!-- SPLIT BILL TAB -->
            <div v-else class="space-y-6 pt-2">
                <div class="bg-gradient-to-br from-[#7CA1B3] to-[#5D6F80] rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-serif italic mb-1 opacity-90">Total Expenses</h2>
                            <p class="text-3xl font-bold mb-6 tracking-tight">{{ formatMoney(totalExpense) }}</p>
                        </div>
                        <button @click="resetExpenses" class="text-xs text-white/50 hover:text-white underline">Reset</button>
                    </div>
                    
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-md border border-white/20">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-3 text-blue-50">Settlement</h3>
                        <ul class="space-y-2 text-sm">
                            <li v-for="debt in settlements" :key="debt.id" class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0 last:pb-0">
                                <span class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 rounded-md bg-white/20 text-xs font-bold">{{ debt.from }}</span>
                                    <i data-lucide="arrow-right" class="w-3 h-3 opacity-50"></i>
                                    <span class="px-2 py-0.5 rounded-md bg-white/20 text-xs font-bold">{{ debt.to }}</span>
                                </span>
                                <span class="font-bold text-white">{{ formatMoney(debt.amount) }}</span>
                            </li>
                            <li v-if="settlements.length === 0" class="text-center opacity-60 text-xs italic">All settled up!</li>
                        </ul>
                    </div>
                </div>

                <div class="glass-card rounded-[20px] p-5">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm">
                        <div class="p-1 bg-emerald-100/50 rounded-md text-emerald-600"><i data-lucide="plus" class="w-3 h-3"></i></div>
                        New Expense
                    </h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.item" placeholder="What for? (e.g. Dinner)" class="w-full bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50 text-slate-700 placeholder:text-slate-400">
                        <div class="flex gap-3">
                            <input v-model.number="newExpense.amount" type="number" placeholder="Amount" class="w-1/2 bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50 text-slate-700 placeholder:text-slate-400">
                            <!-- User Select for Split Bill -->
                            <select v-model="newExpense.payer" class="w-1/2 bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50 text-slate-700">
                                <option value="" disabled>Payer</option>
                                <option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }}</option>
                            </select>
                        </div>
                        <button @click="addExpense" class="w-full bg-[#5D6F80] hover:bg-[#4A5A6A] text-white rounded-xl py-3 text-sm font-bold transition-all shadow-lg shadow-slate-300/50">
                            Add Record
                        </button>
                    </div>
                </div>

                <div class="pb-8">
                    <h3 class="text-xs font-bold text-slate-400 px-4 mb-2 uppercase tracking-wider">History ({{ expenses.length }})</h3>
                    <div class="space-y-2">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="glass-card px-4 py-3 rounded-xl flex justify-between items-center mx-1 group">
                            <div>
                                <div class="font-bold text-sm text-slate-700">{{ exp.item }}</div>
                                <div class="text-[10px] text-slate-500 font-medium bg-slate-100/50 px-2 py-0.5 rounded-full inline-block mt-1">{{ exp.payer }} paid</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="font-bold text-slate-600 text-sm">{{ formatMoney(exp.amount) }}</div>
                                <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                                    <i data-lucide="x" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Floating Action Button -->
        <button 
            v-if="currentTab === 'trip'"
            @click="openModal()"
            class="absolute bottom-24 right-6 w-14 h-14 bg-[#5D6F80] text-white rounded-full shadow-[0_8px_30px_rgb(93,111,128,0.4)] flex items-center justify-center hover:scale-105 transition-all z-20 border border-white/20 backdrop-blur-sm"
        >
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>

        <!-- Bottom Navigation -->
        <nav class="absolute bottom-0 w-full glass-header flex justify-around items-center h-20 pb-2 z-30 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
            <button @click="currentTab = 'trip'" class="flex flex-col items-center gap-1 w-20 group">
                <div class="p-1.5 rounded-2xl transition-all duration-300 relative">
                    <div class="absolute inset-0 bg-[#7CA1B3]/20 blur-md rounded-full opacity-0 group-hover:opacity-100 transition-opacity" v-if="currentTab === 'trip'"></div>
                    <i data-lucide="map" class="w-5 h-5 relative z-10" :class="currentTab === 'trip' ? 'text-[#5D6F80] fill-[#5D6F80]/20' : 'text-slate-400'"></i>
                </div>
                <span class="text-[9px] font-bold tracking-widest transition-colors" :class="currentTab === 'trip' ? 'text-[#5D6F80]' : 'text-slate-400'">ITINERARY</span>
            </button>
            <button @click="currentTab = 'split'" class="flex flex-col items-center gap-1 w-20 group">
                <div class="p-1.5 rounded-2xl transition-all duration-300 relative">
                    <div class="absolute inset-0 bg-[#7CA1B3]/20 blur-md rounded-full opacity-0 group-hover:opacity-100 transition-opacity" v-if="currentTab === 'split'"></div>
                    <i data-lucide="wallet" class="w-5 h-5 relative z-10" :class="currentTab === 'split' ? 'text-[#5D6F80] fill-[#5D6F80]/20' : 'text-slate-400'"></i>
                </div>
                <span class="text-[9px] font-bold tracking-widest transition-colors" :class="currentTab === 'split' ? 'text-[#5D6F80]' : 'text-slate-400'">EXPENSES</span>
            </button>
        </nav>

        <!-- Add/Edit Event Modal -->
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="closeModal"></div>
                <div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white">
                    <h3 class="text-xl font-serif italic font-bold mb-6 text-[#5D6F80]">{{ isEditing ? 'Edit Plan' : 'New Plan' }}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Time</label>
                            <input type="time" v-model="form.time" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Activity</label>
                            <input type="text" v-model="form.title" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Location</label>
                            <input type="text" v-model="form.location" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Type</label>
                            <select v-model="form.typeLabel" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30">
                                <option>FLIGHT</option>
                                <option>HOTEL</option>
                                <option>FOOD</option>
                                <option>ACTIVITY</option>
                                <option>SHOPPING</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-8">
                        <button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold hover:bg-slate-200 transition-colors">Cancel</button>
                        <button @click="saveEvent" class="flex-1 py-3 rounded-xl bg-[#5D6F80] text-white font-bold hover:bg-[#4A5A6A] shadow-lg shadow-slate-400/30 transition-all">Save</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- User Management Modal -->
        <transition name="modal">
            <div v-if="showUserModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="showUserModal = false"></div>
                <div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-serif italic font-bold mb-4 text-[#5D6F80]">Who are you?</h3>
                    
                    <!-- Existing Users Grid -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <button v-for="u in users" :key="u.id" @click="switchUser(u)" class="flex flex-col items-center gap-2 p-3 rounded-2xl border transition-all" :class="currentUser.id === u.id ? 'bg-white border-[#5D6F80]/30 shadow-md ring-2 ring-[#5D6F80]/20' : 'border-transparent hover:bg-white/50'">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-sm" :class="u.bgColor">
                                {{ u.avatar }}
                            </div>
                            <span class="text-xs font-bold text-slate-600 truncate w-full text-center">{{ u.name }}</span>
                        </button>
                    </div>

                    <div class="border-t border-slate-200 my-4"></div>

                    <!-- Create User Form -->
                    <h4 class="text-sm font-bold text-slate-500 mb-3">Or create new user</h4>
                    <div class="space-y-3">
                        <input v-model="newUser.name" placeholder="Your Name" class="w-full bg-slate-100 border-none rounded-xl px-4 py-2 text-sm">
                        
                        <div class="flex gap-2 items-center">
                            <span class="text-xs text-slate-400 font-bold uppercase">Avatar</span>
                            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                                <button v-for="emoji in avatarOptions" :key="emoji" @click="newUser.avatar = emoji" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-white border border-transparent hover:border-slate-200 transition-colors flex-shrink-0" :class="{'ring-2 ring-[#5D6F80]': newUser.avatar === emoji}">
                                    {{ emoji }}
                                </button>
                            </div>
                        </div>

                         <div class="flex gap-2 items-center">
                            <span class="text-xs text-slate-400 font-bold uppercase">Color</span>
                            <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                                <button v-for="(color, idx) in colorOptions" :key="idx" @click="setNewUserColor(color)" class="w-6 h-6 rounded-full border border-slate-200/50 shadow-sm" :class="[color.bg, {'ring-2 ring-offset-2 ring-slate-400': newUser.bgColor === color.bg}]"></button>
                            </div>
                        </div>

                        <button @click="createUser" class="w-full py-3 rounded-xl bg-[#5D6F80]/10 text-[#5D6F80] font-bold border border-[#5D6F80]/20 hover:bg-[#5D6F80]/20 mt-2">
                            Create & Login
                        </button>
                    </div>

                    <div class="mt-4 text-center">
                        <button @click="showUserModal = false" class="text-xs text-slate-400 underline">Close</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Share / Sync Modal -->
        <transition name="modal">
            <div v-if="showShareModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="showShareModal = false"></div>
                <div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white">
                    <h3 class="text-xl font-serif italic font-bold mb-4 text-[#5D6F80]">Sync Data</h3>
                    <p class="text-xs text-slate-500 mb-6">Since this app is offline, use this to share your itinerary updates with friends.</p>
                    
                    <div class="space-y-4">
                        <button @click="copyData" class="w-full py-4 rounded-xl bg-[#5D6F80]/10 text-[#5D6F80] font-bold border border-[#5D6F80]/20 hover:bg-[#5D6F80]/20 flex items-center justify-center gap-2 group">
                            <i data-lucide="copy" class="w-4 h-4"></i> 
                            {{ copyBtnText }}
                        </button>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-slate-200"></div>
                            </div>
                            <div class="relative flex justify-center text-xs">
                                <span class="bg-[#F8FAFC] px-2 text-slate-400">OR LOAD DATA</span>
                            </div>
                        </div>

                        <textarea v-model="importString" placeholder="Paste data code here..." class="w-full h-24 bg-slate-100 border-none rounded-xl p-3 text-xs text-slate-600 focus:ring-2 focus:ring-[#7CA1B3]/30"></textarea>
                        
                        <button @click="loadData" class="w-full py-3 rounded-xl bg-[#5D6F80] text-white font-bold hover:bg-[#4A5A6A] shadow-lg shadow-slate-400/30">
                            Import Data
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button @click="showShareModal = false" class="text-xs text-slate-400 underline">Close</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const currentTab = ref('trip');
                const APP_STORAGE_KEY = 'bangkok_trip_data_v2_collab'; // Updated key version
                
                // --- Dates ---
                const dates = ref([
                    { fullDate: '2025-12-27', monthStr: '12/27', dayNum: '27', weekDay: 'SAT' },
                    { fullDate: '2025-12-28', monthStr: '12/28', dayNum: '28', weekDay: 'SUN' },
                    { fullDate: '2025-12-29', monthStr: '12/29', dayNum: '29', weekDay: 'MON' },
                    { fullDate: '2025-12-30', monthStr: '12/30', dayNum: '30', weekDay: 'TUE' },
                    { fullDate: '2025-12-31', monthStr: '12/31', dayNum: '31', weekDay: 'WED' },
                    { fullDate: '2026-01-01', monthStr: '01/01', dayNum: '01', weekDay: 'THU' },
                    { fullDate: '2026-01-02', monthStr: '01/02', dayNum: '02', weekDay: 'FRI' },
                    { fullDate: '2026-01-03', monthStr: '01/03', dayNum: '03', weekDay: 'SAT' },
                ]);
                const selectedDate = ref('2025-12-27');
                const daysUntilTrip = computed(() => Math.ceil((new Date('2025-12-27') - new Date()) / (1000 * 60 * 60 * 24)));

                // --- User System ---
                const showUserModal = ref(false);
                const defaultUsers = [
                    { id: 'u1', name: 'Me', avatar: 'üòé', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' },
                    { id: 'u2', name: 'Alex', avatar: 'üß¢', bgColor: 'bg-emerald-100', textColor: 'text-emerald-600' },
                    { id: 'u3', name: 'Sarah', avatar: 'üå∏', bgColor: 'bg-rose-100', textColor: 'text-rose-600' },
                    { id: 'u4', name: 'Mike', avatar: 'üé∏', bgColor: 'bg-amber-100', textColor: 'text-amber-600' }
                ];
                const users = ref([...defaultUsers]);
                const currentUser = ref(users.value[0]);
                
                // Create User Logic
                const avatarOptions = ['üòé', 'üß¢', 'üå∏', 'üé∏', 'üê±', 'üê∂', 'ü¶ä', 'ü¶Å', 'üê∏', 'ü¶Ñ', 'üçî', 'üçï'];
                const colorOptions = [
                    { bg: 'bg-indigo-100', text: 'text-indigo-600' },
                    { bg: 'bg-emerald-100', text: 'text-emerald-600' },
                    { bg: 'bg-rose-100', text: 'text-rose-600' },
                    { bg: 'bg-amber-100', text: 'text-amber-600' },
                    { bg: 'bg-sky-100', text: 'text-sky-600' },
                    { bg: 'bg-purple-100', text: 'text-purple-600' },
                ];
                const newUser = ref({ name: '', avatar: 'üòé', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' });
                
                const setNewUserColor = (color) => {
                    newUser.value.bgColor = color.bg;
                    newUser.value.textColor = color.text;
                };

                const createUser = () => {
                    if(!newUser.value.name) return;
                    const u = { 
                        id: 'u' + Date.now(), 
                        ...newUser.value 
                    };
                    users.value.push(u);
                    currentUser.value = u;
                    newUser.value = { name: '', avatar: 'üòé', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' };
                    showUserModal.value = false;
                };

                const switchUser = (u) => {
                    currentUser.value = u;
                    showUserModal.value = false;
                };

                const getUser = (id) => users.value.find(u => u.id === id) || { name: 'Unknown', avatar: '?', bgColor: 'bg-gray-100', textColor: 'text-gray-500' };

                // --- Events & Comments ---
                const defaultEvents = [
                    { id: 101, date: '2025-12-27', time: '03:30', title: 'Ê©üÂ†¥Êé•ÈÄÅÂâçÂæÄÊ©üÂ†¥', location: 'Âè∞ÁÅ£‰ΩèÂÆ∂', typeLabel: 'FLIGHT', desc: 'È†êÁ¥ÑÊôÇÈñì AM 3:30', comments: [] },
                    { id: 102, date: '2025-12-27', time: '07:00', title: 'Êê≠‰πò‰∏≠ËèØËà™Á©∫ CI833 Ëµ∑È£õ', location: 'TPE Airport', typeLabel: 'FLIGHT', comments: [] },
                    { id: 105, date: '2025-12-27', time: '12:30', title: 'È£ØÂ∫ó Check-in / ÂØÑÊîæË°åÊùé', location: 'PARKROYAL Serviced Suites Bangkok', typeLabel: 'HOTEL', desc: '‰ΩçÊñº Sukhumvit Soi 6', comments: [] },
                    { id: 107, date: '2025-12-27', time: '18:00', title: 'ÊôöÈ§êÔºöJodd Fairs ÁÅ´Â±±ÊéíÈ™®', location: 'Jodd Fairs Â§úÂ∏Ç', typeLabel: 'FOOD', comments: [] },
                    { id: 201, date: '2025-12-28', time: '10:00', title: 'ÊÅ∞ÂúñÊÅ∞ÈÄ±Êú´Â∏ÇÈõÜÂ∞ãÂØ∂', location: 'Chatuchak Market', typeLabel: 'SHOPPING', desc: 'Ë®òÂæóÈ†êÁïôÁßªÂãïÊôÇÈñì', comments: [] },
                ];
                const events = ref(defaultEvents);
                
                // Comment Logic
                const openCommentId = ref(null);
                const newCommentTexts = ref({});
                const editingCommentId = ref(null);
                const editingCommentText = ref('');

                const toggleComments = (eventId) => {
                    if (openCommentId.value === eventId) openCommentId.value = null;
                    else openCommentId.value = eventId;
                };

                const addComment = (event) => {
                    const text = newCommentTexts.value[event.id];
                    if (!text) return;
                    
                    if (!event.comments) event.comments = [];
                    event.comments.push({
                        id: Date.now(),
                        userId: currentUser.value.id,
                        text: text,
                        timestamp: Date.now()
                    });
                    newCommentTexts.value[event.id] = '';
                };

                const deleteComment = (event, commentId) => {
                    if (confirm('Delete this comment?')) {
                        event.comments = event.comments.filter(c => c.id !== commentId);
                    }
                };
                
                const startEditComment = (comment) => {
                    editingCommentId.value = comment.id;
                    editingCommentText.value = comment.text;
                };
                
                const saveCommentEdit = (event, comment) => {
                    if (editingCommentText.value.trim() !== '') {
                        comment.text = editingCommentText.value;
                    }
                    editingCommentId.value = null;
                };

                const formatTime = (ts) => {
                    const d = new Date(ts);
                    return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                };

                // --- Styling Logic ---
                const getDateButtonClass = (date) => {
                    const isSelected = selectedDate.value === date.fullDate;
                    if (isSelected) return 'bg-[#5D6F80] text-white shadow-lg shadow-slate-400/50 scale-105 border-transparent';
                    if (date.weekDay === 'SAT') return 'bg-[#D6E6D6]/60 text-[#5A7A5A] border-white/50 hover:bg-[#D6E6D6]';
                    if (date.weekDay === 'SUN') return 'bg-[#E6D6D6]/60 text-[#8A5A5A] border-white/50 hover:bg-[#E6D6D6]';
                    return 'bg-white/30 text-slate-500 border-white/40 hover:bg-white/50';
                };
                const getDotColor = (type) => {
                    const map = { 'FLIGHT': 'bg-blue-300', 'HOTEL': 'bg-indigo-300', 'FOOD': 'bg-amber-300', 'SHOPPING': 'bg-rose-300', 'ACTIVITY': 'bg-emerald-300' };
                    return map[type] || 'bg-slate-300';
                };

                const currentDayEvents = computed(() => events.value.filter(e => e.date === selectedDate.value).sort((a, b) => a.time.localeCompare(b.time)));

                // --- Weather & Maps ---
                const weatherData = ref({});
                const fetchWeather = async () => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=13.7563&longitude=100.5018&daily=temperature_2m_max,weathercode&timezone=Asia%2FBangkok`);
                        const data = await res.json();
                        const todayTemp = data.daily.temperature_2m_max[0];
                        const todayCode = data.daily.weathercode[0];
                        dates.value.forEach(d => {
                            const randomVar = Math.floor(Math.random() * 3) - 1; 
                            weatherData.value[d.fullDate] = { temp: Math.round(todayTemp + randomVar), code: todayCode };
                        });
                    } catch (e) { console.error("Weather err", e); }
                };
                const getWeatherIcon = (code) => {
                    if (code <= 3) return 'sun';
                    if (code <= 48) return 'cloud';
                    if (code <= 67) return 'cloud-rain';
                    return 'cloud-lightning';
                };
                const getGoogleMapsLink = (location) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location + ' Bangkok')}`;

                // --- Event Edit Logic ---
                const showModal = ref(false);
                const isEditing = ref(false);
                const form = ref({ id: null, time: '', title: '', location: '', typeLabel: 'ACTIVITY', desc: '' });
                const openModal = () => { isEditing.value = false; form.value = { id: Date.now(), time: '12:00', title: '', location: '', typeLabel: 'ACTIVITY', desc: '', comments: [] }; showModal.value = true; };
                const editEvent = (event) => { isEditing.value = true; form.value = JSON.parse(JSON.stringify(event)); showModal.value = true; }; // Deep copy
                const closeModal = () => showModal.value = false;
                const saveEvent = () => {
                    if (isEditing.value) {
                        const idx = events.value.findIndex(e => e.id === form.value.id);
                        if (idx !== -1) {
                            // Preserve comments when editing details
                            const existingComments = events.value[idx].comments || [];
                            events.value[idx] = { ...form.value, date: selectedDate.value, comments: existingComments };
                        }
                    } else {
                        events.value.push({ ...form.value, date: selectedDate.value, comments: [] });
                    }
                    closeModal();
                };
                const deleteEvent = (id) => { if(confirm('Remove this plan?')) events.value = events.value.filter(e => e.id !== id); };

                // --- Expenses ---
                const expenses = ref([{ item: 'Airport Van', amount: 1200, payer: 'Alex' }, { item: 'Dinner Day 1', amount: 3000, payer: 'Me' }]);
                const newExpense = ref({ item: '', amount: '', payer: '' });
                const addExpense = () => { if(!newExpense.value.item || !newExpense.value.amount || !newExpense.value.payer) return; expenses.value.push({ ...newExpense.value }); newExpense.value = { item: '', amount: '', payer: '' }; };
                const removeExpense = (idx) => { expenses.value.splice(idx, 1); };
                const resetExpenses = () => { if(confirm('Clear all expenses?')) expenses.value = []; };
                const totalExpense = computed(() => expenses.value.reduce((sum, e) => sum + Number(e.amount), 0));
                
                const settlements = computed(() => {
                    let balances = {}; 
                    // Use names for calculation compatibility
                    users.value.forEach(u => balances[u.name] = 0);
                    
                    const activeUsers = users.value.map(u => u.name);
                    const splitAmount = totalExpense.value / activeUsers.length;
                    
                    expenses.value.forEach(e => {
                        if (balances[e.payer] !== undefined) balances[e.payer] += Number(e.amount);
                    });
                    
                    let debtors = [], creditors = [];
                    for (let u in balances) {
                        const diff = balances[u] - splitAmount;
                        if (diff < -0.01) debtors.push({ user: u, amount: -diff });
                        if (diff > 0.01) creditors.push({ user: u, amount: diff });
                    }
                    
                    let results = [];
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(debtors[i].amount, creditors[j].amount);
                        if (amount > 0) results.push({ from: debtors[i].user, to: creditors[j].user, amount: Math.round(amount) });
                        debtors[i].amount -= amount; creditors[j].amount -= amount;
                        if (debtors[i].amount < 0.1) i++; if (creditors[j].amount < 0.1) j++;
                    }
                    return results;
                });
                const formatMoney = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);

                // --- Data Sync ---
                const showShareModal = ref(false);
                const copyBtnText = ref('Copy Data to Clipboard');
                const importString = ref('');

                const saveDataToStorage = () => {
                    const data = {
                        events: events.value,
                        expenses: expenses.value,
                        users: users.value, // Now saving users
                        timestamp: Date.now()
                    };
                    localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(data));
                };

                const loadDataFromStorage = () => {
                    const saved = localStorage.getItem(APP_STORAGE_KEY);
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            if (data.events) events.value = data.events;
                            if (data.expenses) expenses.value = data.expenses;
                            if (data.users) users.value = data.users; // Restore users
                            // Set default user if not set
                            if(!currentUser.value && users.value.length > 0) currentUser.value = users.value[0];
                        } catch (e) { console.error('Failed to load storage', e); }
                    }
                };

                const copyData = () => {
                    const data = { events: events.value, expenses: expenses.value, users: users.value };
                    navigator.clipboard.writeText(JSON.stringify(data)).then(() => {
                        copyBtnText.value = 'Copied!';
                        setTimeout(() => copyBtnText.value = 'Copy Data to Clipboard', 2000);
                    });
                };

                const loadData = () => {
                    if (!importString.value) return;
                    try {
                        const data = JSON.parse(importString.value);
                        if (data.events) events.value = data.events;
                        if (data.expenses) expenses.value = data.expenses;
                        if (data.users) users.value = data.users;
                        saveDataToStorage();
                        showShareModal.value = false;
                        alert('Data imported successfully!');
                    } catch (e) { alert('Invalid data format!'); }
                };

                watch([events, expenses, users], saveDataToStorage, { deep: true });
                
                onMounted(() => { 
                    loadDataFromStorage(); 
                    lucide.createIcons(); 
                    fetchWeather(); 
                });
                
                Vue.watch([currentTab, events, settlements, openCommentId], () => nextTick(() => lucide.createIcons()), { deep: true });

                return { 
                    currentTab, dates, selectedDate, getDateButtonClass, getDotColor, currentDayEvents, 
                    deleteEvent, users, currentUser, switchUser, createUser, newUser, showUserModal, avatarOptions, colorOptions, setNewUserColor, getUser,
                    expenses, newExpense, addExpense, removeExpense, resetExpenses, totalExpense, settlements, formatMoney, 
                    showModal, openModal, closeModal, saveEvent, form, isEditing, 
                    weatherData, getWeatherIcon, getGoogleMapsLink, daysUntilTrip, 
                    showShareModal, openShareModal: () => { showShareModal.value = true; importString.value = ''; }, copyData, loadData, copyBtnText, importString,
                    // Comment exports
                    toggleComments, openCommentId, addComment, newCommentTexts, deleteComment, startEditComment, saveCommentEdit, editingCommentId, editingCommentText, formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>