<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Tour - Thailand</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Pacifico&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        art: ['Pacifico', 'cursive'],
                    },
                    colors: {
                        morandi: {
                            50: '#F0F4F6',
                            100: '#DDE6EB',
                            200: '#B6C4CC',
                            300: '#94A8B3',
                            400: '#7C909C', // ä¸»è‰²èª¿
                            500: '#607480',
                            600: '#4A5B66',
                            700: '#36444D',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(205,45%,76%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(189,39%,79%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(348,45%,78%,1) 0, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        [v-cloak] { display: none !important; }
        .glass-panel { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        .glass-card { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.6); transition: all 0.3s ease; }
        .glass-card:active { transform: scale(0.98); }
        .glass-input { background: rgba(255, 255, 255, 0.4); border: 1px solid rgba(255, 255, 255, 0.6); backdrop-filter: blur(4px); }
        .glass-input:focus { background: rgba(255, 255, 255, 0.8); outline: none; border-color: #7C909C; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        .swipe-content { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .swipe-active .swipe-content { transform: translateX(-60px); }
        .delete-btn-ios { position: absolute; right: 0; top: 0; bottom: 0; width: 60px; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .swipe-active .delete-btn-ios { opacity: 1; pointer-events: auto; }
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: #4A5B66; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
    </style>
</head>
<body class="text-gray-700 antialiased selection:bg-morandi-200">

<!-- åŠ å…¥ v-cloak é˜²æ­¢æœªç·¨è­¯çš„æ¨¡æ¿é¡¯ç¤º -->
<div id="app" v-cloak class="relative max-w-md mx-auto min-h-screen pb-10 overflow-hidden shadow-2xl bg-white/30 backdrop-blur-sm sm:max-w-md md:max-w-lg lg:max-w-xl">
    
    <!-- èƒŒæ™¯å…ƒç´  -->
    <div class="absolute -top-20 -left-20 w-64 h-64 bg-morandi-200 rounded-full mix-blend-multiply filter blur-2xl opacity-70 animate-pulse"></div>
    <div class="absolute top-40 -right-20 w-72 h-72 bg-blue-200 rounded-full mix-blend-multiply filter blur-2xl opacity-70 animate-pulse"></div>
    <div class="absolute bottom-20 left-10 w-56 h-56 bg-pink-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-pulse"></div>

    <!-- HEADER -->
    <header class="relative z-10 pt-8 pb-4 px-6 glass-panel rounded-b-3xl mb-4 sticky top-0">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-4xl text-morandi-600 tracking-wide font-art drop-shadow-sm">My Tour</h1>
                <div class="mt-3 flex items-center gap-3 bg-white/60 px-4 py-2 rounded-xl backdrop-blur-md border border-white/50 w-fit shadow-sm">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Current</span>
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-location-dot text-morandi-500 text-xs"></i>
                            <span class="text-xs font-bold text-gray-800">{{ headerInfo?.location || 'Loading...' }}</span>
                        </div>
                    </div>
                    <div class="h-6 w-[1px] bg-gray-300"></div>
                    <div class="flex items-center gap-2">
                        <i :class="[headerInfo?.weatherIcon || 'fa-solid fa-sun', 'text-lg']"></i>
                        <span class="text-lg font-bold text-gray-800">{{ headerInfo?.temperature || '--' }}Â°</span>
                    </div>
                    <div class="flex flex-col items-end ml-1 pl-2 border-l border-gray-200">
                        <span class="text-[10px] font-bold text-gray-500">{{ getWeekDay(currentSelectedDate || new Date()) }}</span>
                        <span class="text-[10px] text-gray-400 font-mono">{{ (currentSelectedDate || new Date()).getMonth() + 1 }}/{{ (currentSelectedDate || new Date()).getDate() }}</span>
                    </div>
                </div>
            </div>
            
            <!-- å³å´ï¼šå€‹äººè³‡æ–™èˆ‡ç·¨è¼¯ -->
            <div class="pt-2">
                <div v-if="currentUser" class="flex flex-col items-end gap-2">
                    <button @click="logout" class="flex items-center gap-2 pl-3 pr-1 py-1 bg-white/50 hover:bg-white rounded-full transition-all shadow-sm border border-white group">
                        <span class="text-xs font-bold text-morandi-600">{{ currentUser.name }}</span>
                        <div :class="[currentUser.avatarColor, 'w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-md group-hover:scale-105 transition-transform']">
                            {{ currentUser.avatarEmoji }}
                        </div>
                    </button>
                    <button @click="editCurrentUser" class="flex items-center gap-1.5 px-3 py-1 bg-morandi-400/10 hover:bg-morandi-400/20 text-morandi-600 rounded-full text-[10px] font-bold transition-colors border border-morandi-200">
                        <i class="fa-solid fa-pen"></i> ç·¨è¼¯è³‡æ–™
                    </button>
                </div>
                <button v-else @click="logout" class="px-4 py-2 bg-morandi-400 text-white rounded-full text-xs font-bold shadow-md hover:bg-morandi-500 transition-colors">
                    ç™»å…¥
                </button>
            </div>
        </div>

        <!-- æ—¥æœŸé¸æ“‡ -->
        <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2 pt-2 snap-x" v-if="tripDays.length > 0">
            <button v-for="(day, index) in tripDays" :key="index" @click="selectDay(day)" :class="['flex-shrink-0 w-auto px-4 h-14 rounded-2xl flex items-center justify-center gap-2 transition-all duration-300 snap-center border', isSameDay(day.date, currentSelectedDate) ? 'bg-morandi-400 text-white shadow-lg scale-105 border-transparent' : 'glass-card text-gray-600 hover:bg-white/60 border-white/50', getDayStyle(day.date)]">
                <span class="text-sm font-bold tracking-wide">{{ day.date.getFullYear() }}/{{ (day.date.getMonth() + 1).toString().padStart(2, '0') }}/{{ day.date.getDate().toString().padStart(2, '0') }}</span>
                <span class="text-xs opacity-80">{{ getWeekDay(day.date) }}</span>
            </button>
        </div>
        <div v-else class="text-center py-6 text-gray-400 text-sm bg-white/20 rounded-2xl border border-white/30 backdrop-blur-sm mx-1">
            <span v-if="isDbLoading">è¼‰å…¥è¡Œç¨‹ä¸­... <i class="fa-solid fa-circle-notch fa-spin"></i></span>
            <span v-else><i class="fa-solid fa-plane-up text-2xl mb-2 block opacity-50"></i>ç›®å‰æ²’æœ‰ä»»ä½•è¡Œç¨‹<br>é»æ“Šä¸‹æ–¹ã€Œ<i class="fa-solid fa-plus text-xs"></i>ã€é–‹å§‹è¦åŠƒï¼</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="relative z-0 px-4 pb-10 min-h-[60vh]">
        <!-- Sticky Function Bar -->
        <div class="flex items-center justify-between bg-white/40 backdrop-blur-md rounded-2xl p-3 mb-6 border border-white/50 shadow-sm transition-all sticky top-2 z-20">
            <div class="flex flex-col ml-2">
                <h2 class="text-lg font-bold text-gray-700 leading-tight tracking-wide">
                    {{ currentSelectedDate ? formatDateTitle(currentSelectedDate) : formatDateTitle(new Date()) }}
                </h2>
                <span class="text-xs text-morandi-500 font-medium mt-0.5">{{ filteredItineraries.length }} å€‹è¡Œç¨‹</span>
            </div>
            <div class="flex gap-2">
                <button v-if="isAdmin()" @click="openAiImportModal" class="w-10 h-10 rounded-xl bg-gradient-to-br from-teal-400 to-emerald-400 text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="AI åŒ¯å…¥"><i class="fa-solid fa-file-import text-sm"></i></button>
                <button @click="analyzeItinerary" class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-400 text-white flex items-center justify-center shadow-md hover:scale-105 transition-transform" title="AI å¥æª¢"><i class="fa-solid fa-wand-magic-sparkles text-sm"></i></button>
                <button @click="toggleMemberModal" class="w-10 h-10 rounded-xl bg-white text-morandi-500 border border-morandi-200 flex items-center justify-center shadow-sm hover:bg-gray-50 transition-colors" title="æ—…ä¼´ç®¡ç†"><i class="fa-solid fa-user-group text-sm"></i></button>
                <button @click="openAddModal" class="w-10 h-10 rounded-xl bg-morandi-400 text-white flex items-center justify-center shadow-lg shadow-morandi-300/50 hover:bg-morandi-500 transition-colors" title="æ–°å¢è¡Œç¨‹"><i class="fa-solid fa-plus text-sm"></i></button>
            </div>
        </div>

        <!-- Itinerary List -->
        <div class="space-y-6 relative">
            <div class="absolute left-4 top-4 bottom-4 w-0.5 bg-morandi-200/50 rounded z-0"></div>
            <div v-if="filteredItineraries.length === 0" class="text-center py-12 text-morandi-400 glass-card rounded-2xl mx-2">
                <i class="fa-solid fa-umbrella-beach text-4xl mb-3 opacity-50"></i>
                <p>é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹ï¼Œå¿«å»å®‰æ’å§ï¼</p>
            </div>
            <div v-for="(item, index) in filteredItineraries" :key="item.id" class="relative pl-10 group">
                <div class="absolute left-[9px] top-6 w-3.5 h-3.5 bg-white border-2 border-morandi-400 rounded-full z-10 shadow-sm"></div>
                <div :class="['p-4 rounded-2xl border border-white/60 shadow-sm transition-all relative overflow-hidden', getMemberColorClass(item.creatorId) + '/40', 'backdrop-blur-md']">
                    <div :class="['absolute top-0 right-0 w-24 h-24 rounded-bl-[4rem] -z-10 opacity-30', getMemberColorClass(item.creatorId)]"></div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="inline-block px-2 py-1 bg-white/60 text-morandi-600 text-xs font-bold rounded-lg border border-white/40 shadow-sm">{{ item.time }}</span>
                        <div class="flex space-x-2" v-if="canEditOrDelete(item.creatorId)">
                            <button @click="editItinerary(item)" class="text-gray-500 hover:text-morandi-600 transition-colors w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/40"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button @click="deleteItinerary(item.id, item.creatorId)" class="text-gray-400 hover:text-red-400 transition-colors w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/40"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">{{ item.location }} <span class="text-xs font-normal opacity-60 ml-auto flex items-center gap-1"><span :class="['w-4 h-4 rounded-full flex items-center justify-center text-[10px]', getMemberColorClass(item.creatorId)]">{{ getMemberEmoji(item.creatorId) }}</span> by {{ getMemberName(item.creatorId) }}</span></h3>
                    <p class="text-sm text-gray-700 mb-3 leading-relaxed whitespace-pre-line" v-if="item.note">{{ item.note }}</p>
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-600/10 mb-3">
                        <div class="flex items-center gap-2 text-xs font-medium text-morandi-600 bg-white/40 px-2 py-1 rounded-lg"><i :class="item.weatherIcon" class="text-base"></i><span>{{ item.temperature }}Â°C</span></div>
                        <a :href="getGoogleMapLink(item.location)" target="_blank" class="flex items-center gap-1.5 text-xs font-bold text-morandi-700 hover:text-black transition-colors bg-white/40 px-3 py-1.5 rounded-full shadow-sm hover:shadow-md border border-white/40"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                    </div>
                    <div class="bg-white/30 rounded-xl p-3 mt-2 backdrop-blur-sm border border-white/20">
                        <div class="flex items-center gap-2 mb-2"><i class="fa-regular fa-comments text-xs text-gray-500"></i><span class="text-xs font-bold text-gray-500">ç•™è¨€æ¿ ({{ item.comments ? item.comments.length : 0 }})</span></div>
                        <div v-if="item.comments && item.comments.length > 0" class="space-y-2 mb-3 max-h-32 overflow-y-auto comment-scroll pr-1 overflow-x-hidden">
                            <div v-for="comment in item.comments" :key="comment.id" class="flex gap-2 items-start relative group" :class="{ 'swipe-active': comment.isSwiped }">
                                <button @click.stop="deleteComment(item.id, comment.id)" class="delete-btn-ios bg-red-500 text-white rounded-r-xl z-0 shadow-inner"><i class="fa-solid fa-trash-can"></i></button>
                                <div class="flex gap-2 w-full z-10 swipe-content" @click="toggleSwipe(comment)">
                                    <div :class="['flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-sm mt-1', getMemberColorClass(comment.userId)]">{{ getMemberEmoji(comment.userId) }}</div>
                                    <div :class="['flex-1 p-2 rounded-r-xl rounded-bl-xl text-xs relative select-none cursor-pointer shadow-sm', getMemberColorClass(comment.userId) + '/90']">
                                        <div class="flex justify-between items-start"><span class="font-bold text-gray-800 mr-2">{{ getMemberName(comment.userId) }}</span><span class="text-[10px] text-gray-600 opacity-70">{{ comment.timestamp }}</span></div>
                                        <p class="text-gray-800 break-words mt-0.5">{{ comment.text }}</p>
                                        <div v-if="canDeleteComment(comment.userId) && !comment.isSwiped" class="absolute right-1 bottom-1 opacity-30 text-[8px]"><i class="fa-solid fa-chevron-left"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 relative"><input type="text" v-model="item.newCommentText" @keyup.enter="addComment(item)" placeholder="èªªé»ä»€éº¼..." class="w-full bg-white/50 border-0 rounded-full px-3 py-1.5 text-xs focus:ring-1 focus:ring-morandi-400 placeholder-gray-400 pr-8"><button @click="addComment(item)" class="absolute right-1 top-1 w-6 h-6 bg-morandi-400 text-white rounded-full flex items-center justify-center hover:bg-morandi-500 transition-colors shadow-sm"><i class="fa-solid fa-paper-plane text-[10px] ml-0.5"></i></button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Login Modal (Compact & Fixed) -->
    <div v-if="!currentUser && !isRegistering" class="fixed inset-0 z-[60] flex items-center justify-center px-4 p-safe">
        <div class="absolute inset-0 bg-morandi-400/30 backdrop-blur-md"></div>
        <div class="bg-white/90 backdrop-blur-xl w-full max-w-sm rounded-3xl shadow-2xl relative z-10 text-center border-2 border-white flex flex-col max-h-[75vh] overflow-hidden transition-all duration-300">
            <div class="pt-6 pb-2 px-8 shrink-0">
                <h2 class="text-2xl font-bold text-morandi-600 mb-1 font-art">My Tour</h2>
                <p class="text-xs text-gray-500">è«‹é¸æ“‡ä¸€ä½æˆå“¡ç™»å…¥ä»¥é–‹å§‹ç·¨è¼¯</p>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll px-6 pb-2 min-h-0" v-if="!isDbLoading && !isConfigMissing">
                <div class="grid grid-cols-2 gap-2 pb-2">
                    <button v-for="member in regularMembers" :key="member.id" @click="login(member)" class="flex flex-col items-center justify-center p-1.5 rounded-2xl bg-white/50 hover:bg-white transition-all hover:scale-105 border border-transparent hover:border-morandi-200 shadow-sm min-h-[80px]">
                        <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-xl mb-1 shadow-sm', member.avatarColor]">{{ member.avatarEmoji }}</div>
                        <span class="font-bold text-gray-700 text-xs truncate w-full">{{ member.name }}</span>
                    </button>
                </div>
                <div v-if="regularMembers.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400 text-xs -mt-4"><i class="fa-regular fa-face-smile text-2xl mb-2 opacity-50"></i><p>ç›®å‰é‚„æ²’æœ‰å…¶ä»–æ—…ä¼´</p><p class="mt-1">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ï¼</p></div>
            </div>
            <div v-else class="flex-1 flex flex-col items-center justify-center text-morandi-500 min-h-[120px]">
                <i v-if="!isConfigMissing" class="fa-solid fa-circle-notch fa-spin text-2xl mb-3"></i>
                <span v-if="!isConfigMissing" class="text-xs">é€£çµé›²ç«¯è³‡æ–™åº«ä¸­...</span>
                <span v-else class="text-xs text-red-400">è«‹å®Œæˆè¨­å®šä»¥ç¹¼çºŒ</span>
            </div>
            <div class="p-3 bg-white/60 border-t border-white/50 grid grid-cols-2 gap-3 shrink-0 backdrop-blur-md" v-if="!isDbLoading && !isConfigMissing">
                <button v-if="adminMember" @click="login(adminMember)" class="flex flex-col items-center justify-center p-2 rounded-2xl bg-gradient-to-br from-white to-morandi-50 hover:to-white transition-all hover:scale-105 border border-morandi-200 shadow-sm group">
                    <div :class="['w-9 h-9 rounded-full flex items-center justify-center text-lg mb-1 shadow-sm group-hover:shadow-md transition-shadow', adminMember.avatarColor]">{{ adminMember.avatarEmoji }}</div>
                    <span class="font-bold text-morandi-700 text-xs">{{ adminMember.name }}</span>
                </button>
                <div v-else></div>
                <button @click="openRegisterModal" class="flex flex-col items-center justify-center p-2 rounded-2xl bg-white/40 hover:bg-white/80 transition-all hover:scale-105 border-2 border-dashed border-morandi-300 hover:border-morandi-400 text-morandi-500 group">
                    <div class="w-9 h-9 rounded-full flex items-center justify-center text-lg mb-1 border border-morandi-200 bg-white group-hover:bg-morandi-50"><i class="fa-solid fa-plus text-xs"></i></div>
                    <span class="font-bold text-gray-500 text-xs">æ–°å¢æ—…ä¼´</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Config Error Modal -->
    <div v-if="isConfigMissing" class="fixed inset-0 z-[90] flex items-center justify-center px-4"><div class="absolute inset-0 bg-gray-900/80 backdrop-blur-md"></div><div class="bg-white w-full max-w-md rounded-3xl p-8 shadow-2xl relative z-10 text-center border-2 border-red-100"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-triangle-exclamation text-2xl text-red-500"></i></div><h3 class="text-xl font-bold text-gray-800 mb-2">è¨­å®šæª”ç¼ºå¤±</h3><p class="text-sm text-gray-500 mb-6 leading-relaxed">åµæ¸¬åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨ä¸‹è¼‰çš„æª”æ¡ˆï¼Œä½†å°šæœªè¨­å®š Firebaseã€‚<br>è«‹ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹ html æª”æ¡ˆï¼Œæœå°‹ä¸¦ä¿®æ”¹åº•éƒ¨çš„è¨­å®šæª”ã€‚</p><div class="bg-gray-100 rounded-xl p-4 text-left text-xs font-mono text-gray-600 overflow-x-auto mb-6 border border-gray-200"><code>// TODO: è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Firebase è¨­å®š<br>firebaseConfig = { ... };</code></div><a href="https://console.firebase.google.com/" target="_blank" class="block w-full bg-morandi-400 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-morandi-500 transition-colors">å‰å¾€ Firebase Console</a></div></div>

    <!-- Other Modals -->
    <div v-if="showAiImportModal" class="fixed inset-0 z-[70] flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showAiImportModal = false"></div><div class="bg-white/95 backdrop-blur-xl w-full max-w-md rounded-3xl p-6 shadow-2xl relative z-10 border border-white/50 max-h-[85vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-file-import text-teal-500"></i> AI åŒ¯å…¥è¡Œç¨‹</h3><button @click="showAiImportModal = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div><div v-if="!parsedItineraries.length" class="flex-1 overflow-y-auto custom-scroll"><p class="text-xs text-gray-500 mb-2">è«‹ç›´æ¥è²¼ä¸Šæ–‡å­—è¡Œç¨‹ï¼ˆä¾‹å¦‚ï¼š4/1æ—©ä¸Š10é»å»å¤§çš‡å®®...ï¼‰ï¼ŒAI æœƒè‡ªå‹•å¹«æ‚¨åˆ†ææ•´ç†ã€‚</p><textarea v-model="importText" rows="8" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„è¡Œç¨‹..." class="glass-input w-full px-4 py-3 rounded-xl text-gray-700 resize-none text-sm"></textarea><button @click="parseItinerary" :disabled="!importText.trim() || isParsing" class="mt-4 w-full bg-morandi-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-morandi-300/50 hover:bg-morandi-500 transition-all flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"><i v-if="isParsing" class="fa-solid fa-circle-notch fa-spin"></i><i v-else class="fa-solid fa-wand-magic-sparkles"></i> {{ isParsing ? 'AI åˆ†æä¸­...' : 'é–‹å§‹åˆ†æ' }}</button></div><div v-else class="flex-1 overflow-hidden flex flex-col"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-teal-600">è§£ææˆåŠŸï¼š{{ parsedItineraries.length }} å€‹è¡Œç¨‹</span><button @click="parsedItineraries = []" class="text-xs text-gray-400 hover:text-gray-600 underline">é‡è²¼</button></div><div class="overflow-y-auto custom-scroll bg-gray-50/50 rounded-xl p-2 border border-gray-100 flex-1 mb-4"><div v-for="(item, idx) in parsedItineraries" :key="idx" class="mb-2 p-2 bg-white rounded-lg shadow-sm border border-gray-100 text-xs"><div class="flex justify-between font-bold text-gray-700"><span>{{ item.date }} {{ item.time }}</span><span>{{ item.location }}</span></div><div class="text-gray-500 mt-1 truncate">{{ item.note }}</div></div></div><div class="flex gap-3"><button @click="confirmImport('append')" :disabled="isImporting" class="flex-1 bg-white text-morandi-500 border border-morandi-200 py-2.5 rounded-xl text-sm font-bold hover:bg-gray-50 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"><i v-if="isImporting" class="fa-solid fa-circle-notch fa-spin"></i> åŠ å…¥ç¾æœ‰</button><button @click="confirmImport('overwrite')" :disabled="isImporting" class="flex-1 bg-red-400 text-white py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-red-200 hover:bg-red-500 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"><i v-if="isImporting" class="fa-solid fa-circle-notch fa-spin"></i> è¦†è“‹è¡Œç¨‹</button></div></div></div></div>
    <div v-if="showAiAnalysisModal" class="fixed inset-0 z-[70] flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/30 backdrop-blur-sm" @click="showAiAnalysisModal = false"></div><div class="bg-white/95 backdrop-blur-xl w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10 border border-white/50 max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-robot text-purple-400"></i> AI è¡Œç¨‹åˆ†æ</h3><button @click="showAiAnalysisModal = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="overflow-y-auto custom-scroll prose text-sm text-gray-600 leading-relaxed" v-html="marked.parse(aiAnalysisResult)"></div><button @click="showAiAnalysisModal = false" class="mt-6 w-full bg-morandi-400 text-white py-2 rounded-xl font-bold shadow-md hover:bg-morandi-500">äº†è§£</button></div></div>
    <div v-if="showMemberModal" class="fixed inset-0 z-50 flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/20 backdrop-blur-sm" @click="toggleMemberModal"></div><div class="bg-white/95 backdrop-blur-xl w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10 transform transition-all border border-white/50"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800">æ—…ä¼´ç®¡ç†</h3><button @click="toggleMemberModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button></div><div v-if="!isRegistering" class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scroll mb-6"><div v-for="member in members" :key="member.id" class="flex items-center justify-between bg-white/50 p-3 rounded-xl"><div class="flex items-center gap-3"><div :class="[member.avatarColor, 'flex items-center justify-center w-10 h-10 rounded-full text-xl shadow-sm']">{{ member.avatarEmoji }}</div><div><p class="font-bold text-sm text-gray-800">{{ member.name }}</p><span class="text-[10px] px-2 py-0.5 rounded-full" :class="member.role === 'Admin' ? 'bg-morandi-400 text-white' : 'bg-gray-200 text-gray-500'">{{ member.role }}</span></div></div><div class="flex items-center gap-1"><button v-if="canEditMember(member)" @click="startEditMember(member)" class="text-xs text-morandi-500 bg-white px-2 py-1 rounded-lg border border-morandi-200 hover:bg-morandi-50"><i class="fa-solid fa-pen"></i></button><button v-if="canRemoveMember(member)" @click="removeMember(member)" class="text-xs text-red-400 bg-white px-2 py-1 rounded-lg border border-red-100 hover:bg-red-50"><i class="fa-solid fa-minus"></i></button></div></div></div><div class="pt-4 border-t border-gray-100 relative"><div class="flex justify-between items-center mb-3"><h4 class="text-sm font-bold text-gray-600">{{ isEditingMember ? 'ç·¨è¼¯æˆå“¡è³‡æ–™' : 'æ–°å¢æˆå“¡' }}</h4><button v-if="isEditingMember" @click="resetMemberForm" class="text-xs text-gray-400 hover:text-gray-600 underline">å–æ¶ˆç·¨è¼¯</button></div><div class="mb-4"><input v-model="newMemberName" type="text" placeholder="è¼¸å…¥åå­—..." class="glass-input w-full px-4 py-2.5 rounded-xl text-sm"></div><div class="mb-4"><div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-gray-400">é¸æ“‡é ­åƒ</label><button @click="refreshEmojiOptions" class="text-xs text-morandi-400 hover:text-morandi-600 flex items-center gap-1"><i class="fa-solid fa-rotate"></i> æ›ä¸€æ‰¹</button></div><div class="flex justify-between gap-1"><button v-for="emoji in randomEmojiOptions" :key="emoji" @click="selectedEmoji = emoji" :class="['w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-all', selectedEmoji === emoji ? 'bg-white shadow-md border-2 border-morandi-400 transform scale-110' : 'hover:bg-white/50']">{{ emoji }}</button></div></div><div class="mb-6"><label class="block text-xs font-bold text-gray-400 mb-2">é¸æ“‡ä»£è¡¨è‰²</label><div class="grid grid-cols-6 gap-2"><button v-for="color in avatarColors" :key="color" @click="selectedColor = color" :class="[color, 'w-8 h-8 rounded-full transition-all border-2', selectedColor === color ? 'border-gray-500 scale-110 shadow-md' : 'border-transparent hover:scale-105']"></button></div></div><button @click="saveMember" :class="['w-full text-white px-4 py-3 rounded-xl text-sm font-bold shadow-lg transition-colors flex justify-center items-center gap-2', isEditingMember ? 'bg-morandi-600 hover:bg-morandi-700 shadow-morandi-500/50' : 'bg-morandi-400 hover:bg-morandi-500 shadow-morandi-300/50']"><i :class="isEditingMember ? 'fa-solid fa-check' : 'fa-solid fa-user-plus'"></i> {{ isEditingMember ? 'å„²å­˜è®Šæ›´' : (isRegistering ? 'æ–°å¢ä¸¦ç™»å…¥' : 'åŠ å…¥æ—…ä¼´') }}</button></div></div></div>
    <div v-if="showItineraryModal" class="fixed inset-0 z-50 flex items-center justify-center px-4"><div class="absolute inset-0 bg-black/20 backdrop-blur-sm" @click="closeItineraryModal"></div><div class="bg-white/95 backdrop-blur-xl w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10 border border-white/50"><div :class="['absolute top-0 left-0 w-full h-2 rounded-t-3xl', currentUser ? currentUser.avatarColor : 'bg-gray-200']"></div><h3 class="text-xl font-bold text-gray-800 mb-4 mt-2">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3><div class="space-y-4"><div class="flex gap-3"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">æ—¥æœŸ</label><input v-model="form.date" type="date" class="glass-input w-full px-3 py-3 rounded-xl text-gray-700"></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">æ™‚é–“</label><input v-model="form.time" type="time" class="glass-input w-full px-3 py-3 rounded-xl text-gray-700"></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">åœ°é»</label><div class="flex gap-2"><input v-model="form.location" type="text" placeholder="ä¾‹å¦‚ï¼šé„­ç‹å»Ÿ" class="glass-input flex-1 px-4 py-3 rounded-xl text-gray-700"><button @click="updateMapPreview" class="bg-morandi-100 text-morandi-600 px-3 rounded-xl hover:bg-morandi-200 transition-colors shadow-sm flex-shrink-0" title="åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹"><i class="fa-solid fa-map-location-dot"></i></button></div><div v-if="previewMapUrl" class="mt-2 rounded-xl overflow-hidden border border-white/50 shadow-inner h-32 relative bg-gray-100"><iframe width="100%" height="100%" frameborder="0" style="border:0" :src="previewMapUrl" allowfullscreen loading="lazy"></iframe></div><p class="text-[10px] text-gray-400 mt-1 ml-1" v-else>* è¼¸å…¥åœ°é»å¾Œé»æ“Šå³å´æŒ‰éˆ•ç¢ºèªä½ç½®</p></div><div><label class="block text-xs font-bold text-gray-500 mb-1 ml-1">å‚™è¨» / å°éŠèªª</label><textarea v-model="form.note" rows="4" placeholder="è¨˜å¾—ç©¿é•·è¤²ï¼Œä¸èƒ½ç©¿ç„¡è¢–..." class="glass-input w-full px-4 py-3 rounded-xl text-gray-700 resize-none"></textarea></div></div><div class="flex gap-3 mt-8"><button @click="closeItineraryModal" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors">å–æ¶ˆ</button><button @click="saveItinerary" class="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-morandi-400 hover:bg-morandi-500 shadow-lg shadow-morandi-300/50 transition-colors flex items-center justify-center gap-2"><i v-if="isLoadingWeather" class="fa-solid fa-circle-notch fa-spin"></i> {{ isEditing ? 'å„²å­˜è®Šæ›´' : 'ç¢ºèªæ–°å¢' }}</button></div></div></div>

</div>

<script>
    const apiKey = ""; // API Key
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // --- Firebase Init ---
    let firebaseConfig;
    let appId = 'default-app-id';
    let isConfigValid = true;
    let app, auth, db;

    try {
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        } else {
            // Manual Config
            firebaseConfig = {
                apiKey: "è«‹å¡«å…¥", authDomain: "è«‹å¡«å…¥", projectId: "è«‹å¡«å…¥", storageBucket: "è«‹å¡«å…¥", messagingSenderId: "è«‹å¡«å…¥", appId: "è«‹å¡«å…¥"
            };
            if (firebaseConfig.apiKey === "è«‹å¡«å…¥") isConfigValid = false;
        }

        if (isConfigValid && typeof firebase !== 'undefined') {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
        } else {
            isConfigValid = false;
        }
    } catch (e) { isConfigValid = false; }

    createApp({
        setup() {
            // --- State & Refs ---
            const currentUser = ref(null);
            const members = ref([]);
            const itineraries = ref([]);
            const currentSelectedDate = ref(null);
            const headerInfo = ref({ location: 'Bangkok', temperature: '--', weatherIcon: 'fa-solid fa-sun' });
            
            // Modals
            const showMemberModal = ref(false);
            const showItineraryModal = ref(false);
            const showAiAnalysisModal = ref(false);
            const showAiImportModal = ref(false);
            const isConfigMissing = ref(!isConfigValid);
            
            // UI States
            const isEditing = ref(false);
            const isLoadingWeather = ref(false);
            const isDbLoading = ref(true);
            const isAiLoading = ref(false);
            const isParsing = ref(false);
            const isImporting = ref(false);
            const isRegistering = ref(false);
            const isEditingMember = ref(false);
            const editingMemberId = ref(null);
            const previewMapUrl = ref('');
            
            // Data Holders
            const aiAnalysisResult = ref('');
            const importText = ref('');
            const parsedItineraries = ref([]);
            const newMemberName = ref('');
            const selectedEmoji = ref('');
            const selectedColor = ref('');
            
            // Forms
            const form = ref({ id: null, date: '2025-04-01', time: '09:00', location: '', note: '' });
            const randomEmojiOptions = ref([]);
            
            // Constants
            const allEmojis = ['ğŸ»', 'ğŸ¶', 'ğŸ±', 'ğŸ¦', 'ğŸ¯', 'ğŸ¨', 'ğŸ¼', 'ğŸ°', 'ğŸ¦Š', 'ğŸµ', 'ğŸ¸', 'ğŸ·', 'ğŸ¦„', 'ğŸ', 'ğŸ¢', 'ğŸ™', 'ğŸ¬', 'ğŸ³', 'ğŸ˜', 'ğŸ§š', 'ğŸ§œ', 'ğŸ§›', 'ğŸ§™', 'ğŸ…', 'ğŸ¤´', 'ğŸ‘¸', 'ğŸ¤ ', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ¤–', 'ğŸ‘©â€ğŸ’¼', 'ğŸ‘¨â€ğŸ’»', 'ğŸ•µï¸', 'ğŸ§‘â€ğŸ¨', 'ğŸ‘®', 'ğŸ‘·', 'ğŸ’‚', 'ğŸ‘³', 'ğŸ‘²', 'ğŸ§”'];
            const avatarColors = ['bg-red-200', 'bg-orange-200', 'bg-amber-200', 'bg-lime-200', 'bg-green-200', 'bg-teal-200', 'bg-sky-200', 'bg-blue-200', 'bg-indigo-200', 'bg-violet-200', 'bg-purple-200', 'bg-pink-200'];
            selectedColor.value = avatarColors[0];

            // --- Helper Functions (Defined First) ---
            const getMember = (id) => members.value.find(m => m.id === id);
            const getMemberColorClass = (id) => { const m = getMember(id); return m ? m.avatarColor : 'bg-gray-100'; };
            const getMemberEmoji = (id) => { const m = getMember(id); return m ? m.avatarEmoji : 'ğŸ‘¤'; };
            const getMemberName = (id) => { const m = getMember(id); return m ? m.name : 'Unknown'; };
            const getWeekDay = (date) => { const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­']; return days[date.getDay()]; };
            const getDayStyle = (date) => {
                const day = date.getDay();
                if (isSameDay(date, currentSelectedDate.value)) return '';
                if (day === 6) return 'bg-green-50/80 text-green-600 border-green-100';
                if (day === 0) return 'bg-pink-50/80 text-pink-500 border-pink-100';
                return 'bg-white/40';
            };
            const isSameDay = (d1, d2) => { if (!d1 || !d2) return false; return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); };
            const formatDateISO = (date) => { const offset = date.getTimezoneOffset(); const d = new Date(date.getTime() - (offset*60*1000)); return d.toISOString().split('T')[0]; };
            const formatDateTitle = (date) => { return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ (${getWeekDay(date)})`; };
            const getCurrentTime = () => { const now = new Date(); return now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }); };

            const refreshEmojiOptions = () => {
                const shuffled = [...allEmojis].sort(() => 0.5 - Math.random());
                randomEmojiOptions.value = shuffled.slice(0, 6);
                selectedEmoji.value = randomEmojiOptions.value[0];
            };

            // --- Computed ---
            const tripDays = computed(() => {
                const dates = new Set(itineraries.value.map(i => i.date));
                const sortedDates = Array.from(dates).sort();
                return sortedDates.map(dateStr => {
                    const parts = dateStr.split('-');
                    const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                    return { date: dateObj, iso: dateStr };
                });
            });

            const filteredItineraries = computed(() => {
                if (!currentSelectedDate.value) return [];
                const dateStr = formatDateISO(currentSelectedDate.value);
                return itineraries.value
                    .filter(i => i.date === dateStr)
                    .sort((a, b) => a.time.localeCompare(b.time));
            });

            const adminMember = computed(() => members.value.find(m => m.role === 'Admin'));
            const regularMembers = computed(() => members.value.filter(m => m.role !== 'Admin'));
            
            const isAdmin = () => currentUser.value && currentUser.value.role === 'Admin';
            const canEditOrDelete = (creatorId) => (!currentUser.value) ? false : (isAdmin() || currentUser.value.id === creatorId);
            const canDeleteComment = (userId) => (!currentUser.value) ? false : (isAdmin() || currentUser.value.id === userId);
            const canRemoveMember = (targetMember) => (!currentUser.value) ? false : (isAdmin() && targetMember.role !== 'Admin');
            const canEditMember = (targetMember) => (!currentUser.value) ? false : (isAdmin() || currentUser.value.id === targetMember.id);

            // --- API & Async ---
            const callGeminiAPI = async (prompt, isJsonMode = false) => {
                if (!apiKey && !isConfigValid) return "è«‹å…ˆè¨­å®š API Key";
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], ...(isJsonMode ? { generationConfig: { responseMimeType: "application/json" } } : {}) };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error";
            };

            const fetchRealWeather = async (location) => {
                try {
                    isLoadingWeather.value = true;
                    const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1&language=en&format=json`);
                    const geoData = await geoRes.json();
                    if (!geoData.results || geoData.results.length === 0) return { temp: 30, icon: 'fa-solid fa-sun text-yellow-500' };
                    const { latitude, longitude } = geoData.results[0];
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`);
                    const wData = await weatherRes.json();
                    const code = wData.current_weather.weathercode;
                    let icon = 'fa-solid fa-cloud text-gray-400';
                    if (code === 0) icon = 'fa-solid fa-sun text-yellow-500';
                    else if ([1, 2, 3].includes(code)) icon = 'fa-solid fa-cloud-sun text-orange-400';
                    else if (code >= 95) icon = 'fa-solid fa-bolt text-yellow-600';
                    return { temp: Math.round(wData.current_weather.temperature), icon };
                } catch { return { temp: 30, icon: 'fa-solid fa-sun text-yellow-500' }; }
                finally { isLoadingWeather.value = false; }
            };

            const updateHeaderInfo = async () => {
                const todayItems = filteredItineraries.value;
                if (todayItems.length > 0) {
                    headerInfo.value = { location: todayItems[0].location, temperature: todayItems[0].temperature, weatherIcon: todayItems[0].weatherIcon };
                } else {
                    const weather = await fetchRealWeather('Bangkok');
                    headerInfo.value = { location: 'Bangkok', temperature: weather.temp, weatherIcon: weather.icon };
                }
            };

            // --- Setup Logic ---
            const seedDefaultMembers = async () => {
                const defaults = [
                    { id: '1', name: 'Admin', role: 'Admin', avatarEmoji: 'ğŸ‘©â€ğŸ’¼', avatarColor: 'bg-morandi-200' },
                    { id: '2', name: 'Bob', role: 'Member', avatarEmoji: 'ğŸ‘¨â€ğŸ’»', avatarColor: 'bg-blue-200' },
                ];
                for (const m of defaults) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').add(m);
            };

            const initFirebase = async () => {
                if (!isConfigValid) { isDbLoading.value = false; return; }
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
                else await auth.signInAnonymously();
                if (!auth.currentUser) return;

                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').onSnapshot(snapshot => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, firestoreId: doc.id, ...doc.data() }));
                    if (loaded.length === 0) seedDefaultMembers();
                    else {
                        members.value = loaded;
                        isDbLoading.value = false;
                        const savedId = localStorage.getItem('thailand_trip_user_id');
                        if (savedId && !currentUser.value) {
                            const found = members.value.find(m => m.id === savedId);
                            if (found) currentUser.value = found;
                        }
                    }
                });

                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itineraries').onSnapshot(snapshot => {
                    itineraries.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!currentSelectedDate.value) currentSelectedDate.value = new Date();
                    updateHeaderInfo();
                });
            };

            // --- Actions ---
            const login = (m) => { currentUser.value = m; localStorage.setItem('thailand_trip_user_id', m.id); };
            const logout = () => { currentUser.value = null; localStorage.removeItem('thailand_trip_user_id'); };
            
            const selectDay = (day) => { currentSelectedDate.value = day.date; };
            
            const openAddModal = () => { isEditing.value = false; form.value = { id: null, date: formatDateISO(currentSelectedDate.value || new Date()), time: '10:00', location: '', note: '' }; showItineraryModal.value = true; previewMapUrl.value = ''; };
            const editItinerary = (item) => { isEditing.value = true; form.value = { ...item }; showItineraryModal.value = true; updateMapPreview(); };
            const closeItineraryModal = () => showItineraryModal.value = false;
            
            const updateMapPreview = () => { if (form.value.location) previewMapUrl.value = `https://maps.google.com/maps?q=${encodeURIComponent(form.value.location)}&t=m&z=15&ie=UTF8&iwloc=&output=embed`; };
            const getGoogleMapLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
            
            const saveItinerary = async () => {
                if (!form.value.location) return;
                const w = await fetchRealWeather(form.value.location);
                const data = { ...form.value, temperature: w.temp, weatherIcon: w.icon, creatorId: currentUser.value.id, comments: form.value.comments || [] };
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itineraries');
                if (isEditing.value) await col.doc(form.value.id).update(data);
                else await col.add(data);
                
                const parts = form.value.date.split('-');
                const newDate = new Date(parts[0], parts[1]-1, parts[2]);
                if (!isSameDay(newDate, currentSelectedDate.value)) currentSelectedDate.value = newDate;
                closeItineraryModal();
            };

            const deleteItinerary = async (id, creatorId) => {
                if (!canEditOrDelete(creatorId)) return;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itineraries').doc(id).delete();
            };

            const addComment = async (item) => {
                if (!item.newCommentText.trim()) return;
                const comments = [...(item.comments || []), { id: Date.now(), userId: currentUser.value.id, text: item.newCommentText, timestamp: getCurrentTime() }];
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itineraries').doc(item.id).update({ comments });
                item.newCommentText = '';
            };

            const deleteComment = async (itemId, commentId) => {
                const item = itineraries.value.find(i => i.id === itemId);
                if (item) {
                    const comments = item.comments.filter(c => c.id !== commentId);
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itineraries').doc(itemId).update({ comments });
                }
            };
            
            const toggleSwipe = (c) => { if (canDeleteComment(c.userId)) c.isSwiped = !c.isSwiped; };

            const toggleMemberModal = () => { if (!showMemberModal.value) resetMemberForm(); else if(isRegistering.value) isRegistering.value = false; showMemberModal.value = !showMemberModal.value; };
            const resetMemberForm = () => { isEditingMember.value = false; editingMemberId.value = null; newMemberName.value = ''; refreshEmojiOptions(); selectedColor.value = avatarColors[0]; };
            const openRegisterModal = () => { isRegistering.value = true; showMemberModal.value = true; resetMemberForm(); };
            const startEditMember = (m) => { isEditingMember.value = true; editingMemberId.value = m.firestoreId; newMemberName.value = m.name; selectedEmoji.value = m.avatarEmoji; selectedColor.value = m.avatarColor; };
            const editCurrentUser = () => { if(currentUser.value) { toggleMemberModal(); startEditMember(currentUser.value); } };

            const saveMember = async () => {
                if (!newMemberName.value.trim()) return;
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members');
                const data = { name: newMemberName.value, avatarEmoji: selectedEmoji.value, avatarColor: selectedColor.value };
                
                if (isEditingMember.value) {
                    await col.doc(editingMemberId.value).update(data);
                    resetMemberForm();
                } else {
                    const newData = { ...data, role: 'Member' };
                    const ref = await col.add(newData);
                    if (isRegistering.value) { login({ id: ref.id, firestoreId: ref.id, ...newData }); isRegistering.value = false; showMemberModal.value = false; return; }
                    newMemberName.value = ''; refreshEmojiOptions();
                }
            };

            const removeMember = async (m) => {
                if (canRemoveMember(m)) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members').doc(m.firestoreId).delete();
            };

            // AI features
            const analyzeItinerary = async () => {
                if (filteredItineraries.value.length === 0) return;
                showAiAnalysisModal.value = true; aiAnalysisResult.value = "åˆ†æä¸­...";
                const text = filteredItineraries.value.map(i => `${i.time} ${i.location}`).join('\n');
                aiAnalysisResult.value = await callGeminiAPI(`Analyze this itinerary:\n${text}`);
            };

            const openAiImportModal = () => { showAiImportModal.value = true; importText.value = ''; parsedItineraries.value = []; };
            const parseItinerary = async () => {
                if (!importText.value.trim()) return;
                isParsing.value = true;
                const res = await callGeminiAPI(`Parse to JSON [{"date":"YYYY-MM-DD","time":"HH:mm","location":"","note":""}]:\n${importText.value}`, true);
                try { parsedItineraries.value = JSON.parse(res.replace(/```json|```/g, '').trim()); } catch(e) {}
                isParsing.value = false;
            };
            const confirmImport = async (mode) => {
                if (!parsedItineraries.value.length) return;
                isImporting.value = true;
                const col = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('itineraries');
                if (mode === 'overwrite') {
                    const snap = await col.get();
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
                const batch = db.batch();
                const weathers = await Promise.all(parsedItineraries.value.map(i => fetchRealWeather(i.location)));
                parsedItineraries.value.forEach((item, i) => {
                    const ref = col.doc();
                    batch.set(ref, { ...item, creatorId: currentUser.value.id, temperature: weathers[i].temp, weatherIcon: weathers[i].icon, comments: [] });
                });
                await batch.commit();
                showAiImportModal.value = false; isImporting.value = false;
                if(parsedItineraries.value.length) {
                     const parts = parsedItineraries.value[0].date.split('-');
                     currentSelectedDate.value = new Date(parts[0], parts[1]-1, parts[2]);
                }
            };

            watch(currentSelectedDate, updateHeaderInfo);
            onMounted(() => { refreshEmojiOptions(); initFirebase(); });

            return {
                currentUser, currentSelectedDate, tripDays, members, filteredItineraries,
                showMemberModal, showItineraryModal, showAiAnalysisModal, showAiImportModal,
                isConfigMissing, isDbLoading, isEditing, isLoadingWeather, isAiLoading, isParsing, isImporting,
                isRegistering, isEditingMember, headerInfo, form, newMemberName,
                randomEmojiOptions, selectedEmoji, selectedColor, avatarColors,
                aiAnalysisResult, importText, parsedItineraries, previewMapUrl,
                // Computed
                adminMember, regularMembers,
                // Methods
                getWeekDay, getDayStyle, isSameDay, formatDateTitle, getMemberColorClass, getMemberEmoji, getMemberName,
                login, logout, selectDay, openAddModal, editItinerary, closeItineraryModal, saveItinerary, deleteItinerary,
                toggleMemberModal, saveMember, removeMember, startEditMember, editCurrentUser, resetMemberForm, openRegisterModal, refreshEmojiOptions,
                addComment, deleteComment, toggleSwipe, getGoogleMapLink, updateMapPreview,
                analyzeItinerary, openAiImportModal, parseItinerary, confirmImport,
                // Permissions
                isAdmin, canEditOrDelete, canDeleteComment, canRemoveMember, canEditMember,
                marked
            };
        }
    }).mount('#app');
</script>
</body>
</html>