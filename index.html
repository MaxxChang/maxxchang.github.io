<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangkok Trip (Cloud Sync)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'DM Sans', 'Noto Sans TC', sans-serif; background-color: #F0F4F8; color: #334155; }
        .glass-card { background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        .glass-header { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); } .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        .comment-enter-active, .comment-leave-active { transition: all 0.2s ease; } .comment-enter-from, .comment-leave-to { opacity: 0; transform: translateY(-10px); }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(240, 244, 248, 0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#E8EEF2]">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto shadow-2xl relative overflow-hidden bg-[#F2F5F8]/80">
        
        <!-- Loading Screen -->
        <div v-if="isLoading" class="loading-overlay">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#5D6F80] mb-4"></div>
            <p class="text-[#5D6F80] font-bold animate-pulse">{{ loadingStatus }}</p>
            <p v-if="loadingError" class="text-red-500 text-xs mt-2 px-6 text-center">{{ loadingError }}</p>
        </div>

        <!-- Connection Status -->
        <div v-if="!firebaseConfigured" class="absolute inset-0 z-[60] bg-slate-800/90 backdrop-blur-md flex items-center justify-center p-6 text-center">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm">
                <h2 class="text-xl font-bold text-red-500 mb-2">Setup Required</h2>
                <p class="text-sm text-slate-600 mb-4">Please configure Firebase in the code to enable cloud sync.</p>
                <div class="text-xs text-left bg-slate-100 p-2 rounded mb-4 font-mono overflow-x-auto">
                    const firebaseConfig = { ... }
                </div>
                <button onclick="location.reload()" class="bg-[#5D6F80] text-white px-4 py-2 rounded-lg text-sm">Reload</button>
            </div>
        </div>

        <!-- Header -->
        <header class="pt-10 pb-4 px-6 flex justify-between items-start z-10 glass-header">
            <div>
                <h1 class="text-4xl italic text-[#5D6F80] tracking-wide" style="font-family: 'Playfair Display', serif;">Bangkok</h1>
                <p class="text-[10px] text-[#788998] tracking-[0.3em] mt-1 font-bold uppercase">Cloud Sync 2025</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                 <button @click="showUserModal = true" class="flex items-center gap-2 bg-white/40 pl-3 pr-1 py-1 rounded-full backdrop-blur-sm border border-white/50 hover:bg-white/60 transition-all shadow-sm">
                    <span class="text-xs font-bold text-[#5D6F80] truncate max-w-[60px]">{{ currentUser.name }}</span>
                    <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm shadow-sm" :class="currentUser.bgColor || 'bg-slate-200'">
                        {{ currentUser.avatar }}
                    </div>
                </button>
                <!-- Online Indicator -->
                <div class="flex items-center gap-1 bg-green-100/50 px-2 py-0.5 rounded-full border border-green-200">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[9px] font-bold text-green-700">LIVE</span>
                </div>
            </div>
        </header>

        <!-- Date Selector -->
        <div v-if="currentTab === 'trip'" class="pl-6 mb-4 mt-4 z-10 relative">
            <div class="flex gap-3 overflow-x-auto scrollbar-hide pr-6 pb-4">
                <button v-for="date in dates" :key="date.fullDate" @click="selectedDate = date.fullDate" :class="getDateButtonClass(date)" class="flex-shrink-0 w-[4.2rem] h-[5.5rem] rounded-[20px] flex flex-col items-center justify-center transition-all duration-300 border backdrop-blur-md shadow-sm">
                    <span class="text-[10px] font-bold mb-1 opacity-70">{{ date.monthStr }}</span>
                    <span class="text-xl font-bold mb-1 font-serif">{{ date.dayNum }}</span>
                    <span class="text-[10px] tracking-widest font-bold">{{ date.weekDay }}</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto px-4 pb-28 scrollbar-hide relative z-10">
            <!-- TRIP TAB -->
            <div v-if="currentTab === 'trip'" class="space-y-4">
                <!-- Info Header -->
                <div class="glass-card rounded-2xl p-4 flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100/50 p-2 rounded-full text-[#5D6F80]"><i data-lucide="building-2" class="w-4 h-4"></i></div>
                        <div>
                            <p class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Accommodation</p>
                            <p class="text-xs font-bold text-slate-700 truncate w-48">PARKROYAL Serviced Suites</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end" v-if="weatherData[selectedDate]">
                        <div class="flex items-center gap-1">
                            <i :data-lucide="getWeatherIcon(weatherData[selectedDate].code)" class="w-5 h-5 text-amber-500/80"></i>
                            <span class="text-lg font-bold text-slate-600">{{ weatherData[selectedDate].temp }}Â°</span>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div v-if="currentDayEvents.length === 0" class="text-center py-12 opacity-50">
                    <p class="font-serif italic text-lg text-slate-500">No plans yet...</p>
                </div>

                <!-- Timeline -->
                <div class="relative space-y-4 pl-2">
                    <div class="absolute left-[27px] top-4 bottom-4 w-[1px] bg-slate-300/50 -z-10"></div>
                    <div v-for="event in currentDayEvents" :key="event.id" class="relative group">
                        <div class="absolute left-0 top-6 w-[54px] flex justify-center z-20">
                            <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(event.type)"></div>
                        </div>
                        <div class="glass-card rounded-[24px] p-4 ml-8 transition-all duration-300 hover:bg-white/60">
                            <button @click="deleteEvent(event.id)" class="absolute top-4 right-4 text-slate-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-lg font-bold text-[#5D6F80] font-serif">{{ event.time }}</span>
                                <span class="text-[10px] px-2 py-1 rounded-full bg-white/50 text-slate-500 border border-white/60 font-medium tracking-wide">{{ event.typeLabel || 'ACTIVITY' }}</span>
                            </div>
                            <h3 class="text-base font-bold text-slate-700 mb-1 leading-tight">{{ event.title }}</h3>
                            <div v-if="event.desc" class="text-xs text-slate-500 mb-2 leading-relaxed bg-slate-50/30 p-2 rounded-lg border border-white/20">{{ event.desc }}</div>
                            <div class="flex items-center justify-between mt-3 pt-2 border-t border-slate-100/50">
                                <div class="flex items-center text-slate-400 text-xs gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i><span class="truncate w-24">{{ event.location }}</span></div>
                                <div class="flex gap-2">
                                    <button @click="toggleComments(event.id)" class="flex items-center gap-1 px-2 py-1.5 rounded-full hover:bg-slate-200/50 transition-colors relative" :class="openCommentId === event.id ? 'bg-slate-200/70 text-[#5D6F80]' : 'text-slate-400'">
                                        <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>
                                        <span v-if="event.comments && event.comments.length > 0" class="text-[10px] font-bold">{{ event.comments.length }}</span>
                                    </button>
                                    <button @click="editEvent(event)" class="p-1.5 rounded-full bg-slate-200/40 hover:bg-slate-200/70 text-slate-600 transition-colors"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                            <!-- Comments -->
                            <transition name="comment">
                                <div v-if="openCommentId === event.id" class="mt-3 pt-2 bg-white/40 -mx-4 -mb-4 px-4 pb-4 rounded-b-[24px] border-t border-white/50">
                                    <div v-if="event.comments && event.comments.length > 0" class="space-y-3 mb-3 max-h-40 overflow-y-auto scrollbar-hide">
                                        <div v-for="comment in event.comments" :key="comment.id" class="flex gap-2 items-start text-xs group/item">
                                            <div class="w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] shadow-sm mt-0.5" :class="getUser(comment.userId).bgColor">{{ getUser(comment.userId).avatar }}</div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-baseline mb-0.5"><span class="font-bold" :class="getUser(comment.userId).textColor">{{ getUser(comment.userId).name }}</span><span class="text-[9px] text-slate-400 scale-90 origin-right">{{ formatTime(comment.timestamp) }}</span></div>
                                                <div class="text-slate-600 bg-white/60 p-2 rounded-r-xl rounded-bl-xl inline-block shadow-sm relative pr-6 min-w-[60px]">{{ comment.text }}
                                                    <div v-if="comment.userId === currentUser.id" class="absolute top-1 right-1 opacity-0 group-hover/item:opacity-100 flex gap-1 bg-white/90 rounded px-1">
                                                        <button @click="deleteComment(event, comment.id)" class="text-slate-400 hover:text-red-500"><i data-lucide="trash" class="w-2.5 h-2.5"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-2 text-[10px] text-slate-400 italic">No comments yet.</div>
                                    <div class="flex gap-2 items-center mt-2">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] opacity-50" :class="currentUser.bgColor">{{ currentUser.avatar }}</div>
                                        <input v-model="newCommentTexts[event.id]" placeholder="Add a note..." class="flex-1 bg-white/70 border-none rounded-full px-3 py-1.5 text-xs focus:ring-1 focus:ring-slate-300 placeholder:text-slate-400" @keyup.enter="addComment(event)">
                                        <button @click="addComment(event)" class="text-[#5D6F80] hover:bg-slate-200 p-1.5 rounded-full"><i data-lucide="send" class="w-3.5 h-3.5"></i></button>
                                    </div>
                                </div>
                            </transition>
                        </div>
                    </div>
                </div>
                <div class="h-8"></div>
            </div>

            <!-- SPLIT BILL TAB -->
            <div v-else class="space-y-6 pt-2">
                 <div class="bg-gradient-to-br from-[#7CA1B3] to-[#5D6F80] rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start">
                        <div><h2 class="text-xl font-serif italic mb-1 opacity-90">Total Expenses</h2><p class="text-3xl font-bold mb-6 tracking-tight">{{ formatMoney(totalExpense) }}</p></div>
                        <button @click="resetExpenses" class="text-xs text-white/50 hover:text-white underline">Reset</button>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-md border border-white/20">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-3 text-blue-50">Settlement</h3>
                        <ul class="space-y-2 text-sm">
                            <li v-for="debt in settlements" :key="debt.id" class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0 last:pb-0">
                                <span class="flex items-center gap-2"><span class="px-2 py-0.5 rounded-md bg-white/20 text-xs font-bold">{{ debt.from }}</span><i data-lucide="arrow-right" class="w-3 h-3 opacity-50"></i><span class="px-2 py-0.5 rounded-md bg-white/20 text-xs font-bold">{{ debt.to }}</span></span><span class="font-bold text-white">{{ formatMoney(debt.amount) }}</span>
                            </li>
                            <li v-if="settlements.length === 0" class="text-center opacity-60 text-xs italic">All settled up!</li>
                        </ul>
                    </div>
                </div>
                <div class="glass-card rounded-[20px] p-5">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><div class="p-1 bg-emerald-100/50 rounded-md text-emerald-600"><i data-lucide="plus" class="w-3 h-3"></i></div>New Expense</h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.item" placeholder="What for?" class="w-full bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50">
                        <div class="flex gap-3">
                            <input v-model.number="newExpense.amount" type="number" placeholder="Amount" class="w-1/2 bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50">
                            <select v-model="newExpense.payer" class="w-1/2 bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50">
                                <option value="" disabled>Payer</option>
                                <option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }}</option>
                            </select>
                        </div>
                        <button @click="addExpense" class="w-full bg-[#5D6F80] hover:bg-[#4A5A6A] text-white rounded-xl py-3 text-sm font-bold transition-all shadow-lg shadow-slate-300/50">Add Record</button>
                    </div>
                </div>
                <div class="pb-8">
                    <h3 class="text-xs font-bold text-slate-400 px-4 mb-2 uppercase tracking-wider">History ({{ expenses.length }})</h3>
                    <div class="space-y-2">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="glass-card px-4 py-3 rounded-xl flex justify-between items-center mx-1 group">
                            <div><div class="font-bold text-sm text-slate-700">{{ exp.item }}</div><div class="text-[10px] text-slate-500 font-medium bg-slate-100/50 px-2 py-0.5 rounded-full inline-block mt-1">{{ exp.payer }} paid</div></div>
                            <div class="flex items-center gap-3"><div class="font-bold text-slate-600 text-sm">{{ formatMoney(exp.amount) }}</div><button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="x" class="w-3 h-3"></i></button></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals and Bottom Nav (Same as before) -->
        <button v-if="currentTab === 'trip'" @click="openModal()" class="absolute bottom-24 right-6 w-14 h-14 bg-[#5D6F80] text-white rounded-full shadow-[0_8px_30px_rgb(93,111,128,0.4)] flex items-center justify-center hover:scale-105 transition-all z-20 border border-white/20 backdrop-blur-sm"><i data-lucide="plus" class="w-6 h-6"></i></button>
        <nav class="absolute bottom-0 w-full glass-header flex justify-around items-center h-20 pb-2 z-30 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
            <button @click="currentTab = 'trip'" class="flex flex-col items-center gap-1 w-20 group"><div class="p-1.5 rounded-2xl transition-all duration-300 relative"><div class="absolute inset-0 bg-[#7CA1B3]/20 blur-md rounded-full opacity-0 group-hover:opacity-100 transition-opacity" v-if="currentTab === 'trip'"></div><i data-lucide="map" class="w-5 h-5 relative z-10" :class="currentTab === 'trip' ? 'text-[#5D6F80] fill-[#5D6F80]/20' : 'text-slate-400'"></i></div><span class="text-[9px] font-bold tracking-widest transition-colors" :class="currentTab === 'trip' ? 'text-[#5D6F80]' : 'text-slate-400'">ITINERARY</span></button>
            <button @click="currentTab = 'split'" class="flex flex-col items-center gap-1 w-20 group"><div class="p-1.5 rounded-2xl transition-all duration-300 relative"><div class="absolute inset-0 bg-[#7CA1B3]/20 blur-md rounded-full opacity-0 group-hover:opacity-100 transition-opacity" v-if="currentTab === 'split'"></div><i data-lucide="wallet" class="w-5 h-5 relative z-10" :class="currentTab === 'split' ? 'text-[#5D6F80] fill-[#5D6F80]/20' : 'text-slate-400'"></i></div><span class="text-[9px] font-bold tracking-widest transition-colors" :class="currentTab === 'split' ? 'text-[#5D6F80]' : 'text-slate-400'">EXPENSES</span></button>
        </nav>

        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="closeModal"></div><div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white"><h3 class="text-xl font-serif italic font-bold mb-6 text-[#5D6F80]">{{ isEditing ? 'Edit Plan' : 'New Plan' }}</h3><div class="space-y-4"><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Time</label><input type="time" v-model="form.time" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"></div><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Activity</label><input type="text" v-model="form.title" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"></div><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Location</label><input type="text" v-model="form.location" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"></div><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Type</label><select v-model="form.typeLabel" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"><option>FLIGHT</option><option>HOTEL</option><option>FOOD</option><option>ACTIVITY</option><option>SHOPPING</option></select></div></div><div class="flex gap-3 mt-8"><button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold hover:bg-slate-200 transition-colors">Cancel</button><button @click="saveEvent" class="flex-1 py-3 rounded-xl bg-[#5D6F80] text-white font-bold hover:bg-[#4A5A6A] shadow-lg shadow-slate-400/30 transition-all">Save</button></div></div></div>
        </transition>

        <transition name="modal">
            <div v-if="showUserModal" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="showUserModal = false"></div><div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white max-h-[90vh] overflow-y-auto"><h3 class="text-xl font-serif italic font-bold mb-4 text-[#5D6F80]">Who are you?</h3><div class="grid grid-cols-3 gap-3 mb-6"><button v-for="u in users" :key="u.id" @click="switchUser(u)" class="flex flex-col items-center gap-2 p-3 rounded-2xl border transition-all" :class="currentUser.id === u.id ? 'bg-white border-[#5D6F80]/30 shadow-md ring-2 ring-[#5D6F80]/20' : 'border-transparent hover:bg-white/50'"><div class="w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-sm" :class="u.bgColor">{{ u.avatar }}</div><span class="text-xs font-bold text-slate-600 truncate w-full text-center">{{ u.name }}</span></button></div><div class="border-t border-slate-200 my-4"></div><h4 class="text-sm font-bold text-slate-500 mb-3">Or create new user</h4><div class="space-y-3"><input v-model="newUser.name" placeholder="Your Name" class="w-full bg-slate-100 border-none rounded-xl px-4 py-2 text-sm"><div class="flex gap-2 items-center"><span class="text-xs text-slate-400 font-bold uppercase">Avatar</span><div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide"><button v-for="emoji in avatarOptions" :key="emoji" @click="newUser.avatar = emoji" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-white border border-transparent hover:border-slate-200 transition-colors flex-shrink-0" :class="{'ring-2 ring-[#5D6F80]': newUser.avatar === emoji}">{{ emoji }}</button></div></div><div class="flex gap-2 items-center"><span class="text-xs text-slate-400 font-bold uppercase">Color</span><div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide"><button v-for="(color, idx) in colorOptions" :key="idx" @click="setNewUserColor(color)" class="w-6 h-6 rounded-full border border-slate-200/50 shadow-sm" :class="[color.bg, {'ring-2 ring-offset-2 ring-slate-400': newUser.bgColor === color.bg}]"></button></div></div><button @click="createUser" class="w-full py-3 rounded-xl bg-[#5D6F80]/10 text-[#5D6F80] font-bold border border-[#5D6F80]/20 hover:bg-[#5D6F80]/20 mt-2">Create & Login</button></div><div class="mt-4 text-center"><button @click="showUserModal = false" class="text-xs text-slate-400 underline">Close</button></div></div></div>
        </transition>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // -----------------------------------------------------------
        // ðŸ”´ è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Firebase Config
        // 1. åŽ» console.firebase.google.com å»ºç«‹å°ˆæ¡ˆ
        // 2. æ–°å¢ž Web App -> è¤‡è£½ Config ç‰©ä»¶è²¼åœ¨ä¸‹é¢
        // 3. åœ¨ Firebase Console -> Firestore Database -> Create Database
        // 4. è¨­å®š Rules ç‚º allow read, write: if true; (æ¸¬è©¦ç”¨)
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDkbk-p6uBbrQP83IlAMXz4ZNsbLpHsXzM",
            authDomain: "bangkoktrip2026.firebaseapp.com",
            projectId: "bangkoktrip2026",
            storageBucket: "bangkoktrip2026.firebasestorage.app",
            messagingSenderId: "581976273324",
            appId: "1:581976273324:web:440d58bcdcedb7320eca09"
        };

        createApp({
            setup() {
                // Check if config is present
                const firebaseConfigured = ref(Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_API_KEY");
                const isLoading = ref(true);
                const loadingStatus = ref("Connecting to Cloud...");
                const loadingError = ref("");
                let db = null;
                let auth = null;
                const TRIP_DOC_ID = 'bangkok2025_trip_data'; // The ID in Firestore

                // Data Refs (Init first)
                const currentTab = ref('trip');
                const users = ref([
                    { id: 'u1', name: 'Me', avatar: 'ðŸ˜Ž', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' },
                    { id: 'u2', name: 'Alex', avatar: 'ðŸ§¢', bgColor: 'bg-emerald-100', textColor: 'text-emerald-600' }
                ]);
                const currentUser = ref(users.value[0]);
                const events = ref([]);
                const expenses = ref([]);

                // Init Firebase
                if(firebaseConfigured.value) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                    } catch(e) { 
                        console.error("Firebase init error:", e);
                        loadingError.value = "Init Failed: " + e.message;
                    }
                }

                
                // --- Dates ---
                const dates = ref([
                    { fullDate: '2025-12-27', monthStr: '12/27', dayNum: '27', weekDay: 'SAT' },
                    { fullDate: '2025-12-28', monthStr: '12/28', dayNum: '28', weekDay: 'SUN' },
                    { fullDate: '2025-12-29', monthStr: '12/29', dayNum: '29', weekDay: 'MON' },
                    { fullDate: '2025-12-30', monthStr: '12/30', dayNum: '30', weekDay: 'TUE' },
                    { fullDate: '2025-12-31', monthStr: '12/31', dayNum: '31', weekDay: 'WED' },
                    { fullDate: '2026-01-01', monthStr: '01/01', dayNum: '01', weekDay: 'THU' },
                    { fullDate: '2026-01-02', monthStr: '01/02', dayNum: '02', weekDay: 'FRI' },
                    { fullDate: '2026-01-03', monthStr: '01/03', dayNum: '03', weekDay: 'SAT' },
                ]);
                const selectedDate = ref('2025-12-27');

                // --- Sync Logic (The Magic) ---
                const saveDataToCloud = async () => {
                    if(!db) return;
                    try {
                        await setDoc(doc(db, "trips", TRIP_DOC_ID), {
                            events: events.value,
                            expenses: expenses.value,
                            users: users.value,
                            lastUpdated: new Date().toISOString()
                        });
                    } catch(e) { console.error("Save failed", e); }
                };

                // Watch for changes and save (Debounced slightly could be better, but direct is fine for small app)
                watch([events, expenses, users], () => {
                   if(!isLoading.value) saveDataToCloud();
                }, { deep: true });

                const initFirebaseConnection = async () => {
                    if (!db || !auth) {
                        isLoading.value = false;
                        return;
                    }
                    
                    try {
                        loadingStatus.value = "Authenticating...";
                        await signInAnonymously(auth);
                        loadingStatus.value = "Syncing Data...";

                        const unsub = onSnapshot(doc(db, "trips", TRIP_DOC_ID), (doc) => {
                            isLoading.value = false;
                            if (doc.exists()) {
                                const data = doc.data();
                                if(data.events) events.value = data.events;
                                if(data.expenses) expenses.value = data.expenses;
                                if(data.users) users.value = data.users;
                            } else {
                                // No data yet in cloud? Init with defaults
                                isLoading.value = false;
                                saveDataToCloud();
                            }
                        }, (err) => {
                            console.error("Sync error:", err);
                            loadingError.value = "Sync Error: " + err.message;
                            // Keep loading screen but show error, or dismiss it?
                            // Better to let user see the error
                        });

                    } catch (error) {
                        console.error("Auth failed:", error);
                        loadingError.value = "Auth Failed: " + error.message;
                    }
                };

                // Real-time Listener
                onMounted(() => {
                    lucide.createIcons();
                    fetchWeather();
                    initFirebaseConnection();
                });

                // --- Helpers & UI Logic (Same as before) ---
                const getDateButtonClass = (date) => {
                    const isSelected = selectedDate.value === date.fullDate;
                    if (isSelected) return 'bg-[#5D6F80] text-white shadow-lg shadow-slate-400/50 scale-105 border-transparent';
                    if (date.weekDay === 'SAT') return 'bg-[#D6E6D6]/60 text-[#5A7A5A] border-white/50 hover:bg-[#D6E6D6]';
                    if (date.weekDay === 'SUN') return 'bg-[#E6D6D6]/60 text-[#8A5A5A] border-white/50 hover:bg-[#E6D6D6]';
                    return 'bg-white/30 text-slate-500 border-white/40 hover:bg-white/50';
                };
                const getDotColor = (type) => {
                    const map = { 'FLIGHT': 'bg-blue-300', 'HOTEL': 'bg-indigo-300', 'FOOD': 'bg-amber-300', 'SHOPPING': 'bg-rose-300', 'ACTIVITY': 'bg-emerald-300' };
                    return map[type] || 'bg-slate-300';
                };
                const currentDayEvents = computed(() => events.value.filter(e => e.date === selectedDate.value).sort((a, b) => a.time.localeCompare(b.time)));

                // User
                const newUser = ref({ name: '', avatar: 'ðŸ˜Ž', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' });
                const avatarOptions = ['ðŸ˜Ž', 'ðŸ§¢', 'ðŸŒ¸', 'ðŸŽ¸', 'ðŸ±', 'ðŸ¶', 'ðŸ¦Š', 'ðŸ¦', 'ðŸ¸', 'ðŸ¦„', 'ðŸ”', 'ðŸ•'];
                const colorOptions = [{ bg: 'bg-indigo-100', text: 'text-indigo-600' }, { bg: 'bg-emerald-100', text: 'text-emerald-600' }, { bg: 'bg-rose-100', text: 'text-rose-600' }, { bg: 'bg-amber-100', text: 'text-amber-600' }, { bg: 'bg-sky-100', text: 'text-sky-600' }, { bg: 'bg-purple-100', text: 'text-purple-600' }];
                const showUserModal = ref(false);
                const setNewUserColor = (c) => { newUser.value.bgColor = c.bg; newUser.value.textColor = c.text; };
                const createUser = () => { if(!newUser.value.name) return; const u = { id: 'u'+Date.now(), ...newUser.value }; users.value.push(u); currentUser.value = u; newUser.value = { name: '', avatar: 'ðŸ˜Ž', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' }; showUserModal.value = false; };
                const switchUser = (u) => { currentUser.value = u; showUserModal.value = false; };
                const getUser = (id) => users.value.find(u => u.id === id) || { name: 'Unknown', avatar: '?', bgColor: 'bg-gray-100', textColor: 'text-gray-500' };

                // Comments
                const openCommentId = ref(null);
                const newCommentTexts = ref({});
                const toggleComments = (id) => openCommentId.value = (openCommentId.value === id ? null : id);
                const addComment = (event) => {
                    const text = newCommentTexts.value[event.id];
                    if (!text) return;
                    if (!event.comments) event.comments = [];
                    event.comments.push({ id: Date.now(), userId: currentUser.value.id, text: text, timestamp: Date.now() });
                    newCommentTexts.value[event.id] = '';
                };
                const deleteComment = (event, cid) => { if(confirm('Delete?')) event.comments = event.comments.filter(c => c.id !== cid); };
                const formatTime = (ts) => { const d = new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`; };

                // Event Edit
                const showModal = ref(false);
                const isEditing = ref(false);
                const form = ref({});
                const openModal = () => { isEditing.value = false; form.value = { id: Date.now(), time: '12:00', title: '', location: '', typeLabel: 'ACTIVITY', desc: '', comments: [] }; showModal.value = true; };
                const editEvent = (evt) => { isEditing.value = true; form.value = JSON.parse(JSON.stringify(evt)); showModal.value = true; };
                const closeModal = () => showModal.value = false;
                const saveEvent = () => {
                    if (isEditing.value) {
                        const idx = events.value.findIndex(e => e.id === form.value.id);
                        if (idx !== -1) events.value[idx] = { ...form.value, date: selectedDate.value, comments: events.value[idx].comments };
                    } else { events.value.push({ ...form.value, date: selectedDate.value, comments: [] }); }
                    closeModal();
                };
                const deleteEvent = (id) => { if(confirm('Delete?')) events.value = events.value.filter(e => e.id !== id); };

                // Expenses
                const newExpense = ref({ item: '', amount: '', payer: '' });
                const addExpense = () => { if(!newExpense.value.item || !newExpense.value.amount || !newExpense.value.payer) return; expenses.value.push({ ...newExpense.value }); newExpense.value = { item: '', amount: '', payer: '' }; };
                const removeExpense = (idx) => expenses.value.splice(idx, 1);
                const resetExpenses = () => { if(confirm('Reset?')) expenses.value = []; };
                const totalExpense = computed(() => expenses.value.reduce((sum, e) => sum + Number(e.amount), 0));
                const settlements = computed(() => {
                    let balances = {}; users.value.forEach(u => balances[u.name] = 0);
                    const activeUsers = users.value.map(u => u.name);
                    const splitAmount = totalExpense.value / (activeUsers.length || 1);
                    expenses.value.forEach(e => { if (balances[e.payer] !== undefined) balances[e.payer] += Number(e.amount); });
                    let debtors = [], creditors = [];
                    for (let u in balances) { const diff = balances[u] - splitAmount; if (diff < -0.01) debtors.push({ user: u, amount: -diff }); if (diff > 0.01) creditors.push({ user: u, amount: diff }); }
                    let results = [], i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(debtors[i].amount, creditors[j].amount);
                        if (amount > 0) results.push({ from: debtors[i].user, to: creditors[j].user, amount: Math.round(amount) });
                        debtors[i].amount -= amount; creditors[j].amount -= amount;
                        if (debtors[i].amount < 0.1) i++; if (creditors[j].amount < 0.1) j++;
                    }
                    return results;
                });
                const formatMoney = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
                
                // Weather
                const weatherData = ref({});
                const fetchWeather = async () => {
                     try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=13.7563&longitude=100.5018&daily=temperature_2m_max,weathercode&timezone=Asia%2FBangkok`); const data = await res.json(); const todayTemp = data.daily.temperature_2m_max[0]; const todayCode = data.daily.weathercode[0]; dates.value.forEach(d => { weatherData.value[d.fullDate] = { temp: Math.round(todayTemp + Math.floor(Math.random() * 3) - 1), code: todayCode }; }); } catch (e) {}
                };
                const getWeatherIcon = (code) => { if (code <= 3) return 'sun'; if (code <= 48) return 'cloud'; if (code <= 67) return 'cloud-rain'; return 'cloud-lightning'; };

                Vue.watch([currentTab, events, settlements, openCommentId], () => nextTick(() => lucide.createIcons()), { deep: true });

                return { 
                    firebaseConfigured, isLoading, loadingStatus, loadingError,
                    currentTab, dates, selectedDate, getDateButtonClass, getDotColor, currentDayEvents, 
                    users, currentUser, switchUser, createUser, newUser, showUserModal, avatarOptions, colorOptions, setNewUserColor, getUser,
                    events, deleteEvent, expenses, newExpense, addExpense, removeExpense, resetExpenses, totalExpense, settlements, formatMoney, 
                    showModal, openModal, closeModal, saveEvent, form, isEditing, 
                    weatherData, getWeatherIcon, toggleComments, openCommentId, addComment, newCommentTexts, deleteComment, formatTime, editEvent
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
