<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- Updated Viewport to prevent auto-zoom on inputs -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- iOS Web App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BKK 2025">
    
    <!-- App Icon -->
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" type="image/png" href="/icon.png">
    
    <title>Bangkok Trip (Cloud Sync + AI)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'DM Sans', 'Noto Sans TC', sans-serif; background-color: #F0F4F8; color: #334155; }
        
        /* Glass Cards */
        .glass-card { 
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); 
        }
        .member-card {
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05); 
        }
        .ai-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 249, 255, 0.9) 100%);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.15);
        }

        .glass-header { background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); } .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        .comment-enter-active, .comment-leave-active { transition: all 0.2s ease; } .comment-enter-from, .comment-leave-to { opacity: 0; transform: translateY(-10px); }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(240, 244, 248, 0.95); backdrop-filter: blur(5px); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        input, textarea, select { font-size: 16px !important; }

        /* AI Gradient Text */
        .text-gradient-ai {
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#E8EEF2]">

    <div id="app" class="h-full flex flex-col max-w-md mx-auto shadow-2xl relative overflow-hidden bg-[#F2F5F8]/80">
        
        <!-- Loading Screen -->
        <div v-if="isLoading" class="loading-overlay text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#5D6F80] mb-4"></div>
            <p class="text-[#5D6F80] font-bold animate-pulse text-lg mb-2">{{ loadingStatus }}</p>
            <div v-if="loadingError" class="bg-red-50 text-red-600 p-4 rounded-xl border border-red-200 text-sm max-w-xs shadow-sm">
                <div class="font-bold mb-1 flex items-center justify-center gap-1"><i data-lucide="alert-triangle" class="w-4 h-4"></i> é€£ç·šéŒ¯èª¤</div>
                {{ loadingError }}
                <button onclick="location.reload()" class="mt-3 bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg text-xs font-bold w-full transition-colors">é‡æ–°æ•´ç†</button>
            </div>
        </div>

        <!-- Connection Status (Config Missing) -->
        <div v-if="!firebaseConfigured" class="absolute inset-0 z-[60] bg-slate-800/90 backdrop-blur-md flex items-center justify-center p-6 text-center">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm">
                <h2 class="text-xl font-bold text-red-500 mb-2">Setup Required</h2>
                <p class="text-sm text-slate-600 mb-4">Please configure Firebase in the code to enable cloud sync.</p>
                <div class="text-xs text-left bg-slate-100 p-2 rounded mb-4 font-mono overflow-x-auto">
                    const firebaseConfig = { ... }
                </div>
                <button onclick="location.reload()" class="bg-[#5D6F80] text-white px-4 py-2 rounded-lg text-sm">Reload</button>
            </div>
        </div>

        <!-- Header -->
        <header class="pt-10 pb-4 px-6 flex justify-between items-start z-10 glass-header">
            <div>
                <h1 class="text-4xl italic text-[#5D6F80] tracking-wide" style="font-family: 'Playfair Display', serif;">Bangkok</h1>
                <p class="text-[10px] text-[#788998] tracking-[0.3em] mt-1 font-bold uppercase">Cloud Sync 2025</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                 <div class="flex gap-2">
                     <!-- AI Button -->
                     <button @click="showAIModal = true" class="p-2 rounded-full bg-indigo-50 border border-indigo-100 text-indigo-500 hover:bg-indigo-100 transition-colors relative group">
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                        <span class="absolute -top-1 -right-1 w-2 h-2 bg-pink-500 rounded-full animate-ping" v-if="!apiKey"></span>
                     </button>
                     <!-- User Profile -->
                     <button @click="showUserModal = true" class="flex items-center gap-2 bg-white/40 pl-3 pr-1 py-1 rounded-full backdrop-blur-sm border border-white/50 hover:bg-white/60 transition-all shadow-sm">
                        <span class="text-xs font-bold text-[#5D6F80] truncate max-w-[60px]">{{ currentUser.name }}</span>
                        <div class="w-7 h-7 rounded-full flex items-center justify-center text-sm shadow-sm" :class="currentUser.bgColor || 'bg-slate-200'">
                            {{ currentUser.avatar }}
                        </div>
                    </button>
                 </div>
                <!-- Online Indicator -->
                <div class="flex items-center gap-1 bg-green-100/50 px-2 py-0.5 rounded-full border border-green-200">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[9px] font-bold text-green-700">LIVE</span>
                </div>
            </div>
        </header>

        <!-- Date Selector -->
        <div v-if="currentTab === 'trip'" class="pl-6 mb-4 mt-4 z-10 relative">
            <div class="flex gap-3 overflow-x-auto scrollbar-hide pr-6 pb-4">
                <button v-for="date in dates" :key="date.fullDate" @click="selectedDate = date.fullDate" :class="getDateButtonClass(date)" class="flex-shrink-0 w-[4.2rem] h-[5.5rem] rounded-[20px] flex flex-col items-center justify-center transition-all duration-300 border backdrop-blur-md shadow-sm">
                    <span class="text-[10px] font-bold mb-1 opacity-70">{{ date.monthStr }}</span>
                    <span class="text-xl font-bold mb-1 font-serif">{{ date.dayNum }}</span>
                    <span class="text-[10px] tracking-widest font-bold">{{ date.weekDay }}</span>
                </button>
            </div>
        </div>

        <!-- Main Content (Same as before) -->
        <main class="flex-1 overflow-y-auto px-4 pb-28 scrollbar-hide relative z-10">
            <!-- TRIP TAB -->
            <div v-if="currentTab === 'trip'" class="space-y-4">
                <div class="glass-card rounded-2xl p-4 flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100/50 p-2 rounded-full text-[#5D6F80]"><i data-lucide="building-2" class="w-4 h-4"></i></div>
                        <div>
                            <p class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Accommodation</p>
                            <p class="text-xs font-bold text-slate-700 truncate w-48">PARKROYAL Serviced Suites</p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end" v-if="weatherData[selectedDate]">
                        <div class="flex items-center gap-1">
                            <i :data-lucide="getWeatherIcon(weatherData[selectedDate].code)" class="w-5 h-5 text-amber-500/80"></i>
                            <span class="text-lg font-bold text-slate-600">{{ weatherData[selectedDate].temp }}Â°</span>
                        </div>
                    </div>
                </div>

                <div v-if="currentDayEvents.length === 0" class="text-center py-12 opacity-50">
                    <p class="font-serif italic text-lg text-slate-500">No plans yet...</p>
                </div>

                <div class="relative space-y-4 pl-2">
                    <div class="absolute left-[27px] top-4 bottom-4 w-[1px] bg-slate-300/50 -z-10"></div>
                    <div v-for="event in currentDayEvents" :key="event.id" class="relative group">
                        <div class="absolute left-0 top-6 w-[54px] flex justify-center z-20">
                            <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm" :class="getDotColor(event.type)"></div>
                        </div>
                        <div class="rounded-[24px] p-4 ml-8 transition-all duration-300" :class="getCardStyle(event.userId)">
                            <button @click="deleteEvent(event.id)" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition-colors p-1.5 bg-white rounded-full shadow-sm z-20">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                            <div class="flex justify-between items-start mb-2 pr-8">
                                <span class="text-lg font-bold text-[#5D6F80] font-serif">{{ event.time }}</span>
                                <span class="text-[10px] px-2 py-1 rounded-full bg-white/50 text-slate-500 border border-white/60 font-medium tracking-wide">{{ event.typeLabel || 'ACTIVITY' }}</span>
                            </div>
                            <h3 class="text-base font-bold text-slate-700 mb-1 leading-tight">{{ event.title }}</h3>
                            <div v-if="event.desc" class="text-xs text-slate-500 mb-2 leading-relaxed bg-white/30 p-2 rounded-lg border border-white/20">{{ event.desc }}</div>
                            <div class="flex items-center justify-between mt-3 pt-2 border-t border-slate-500/10">
                                <div class="flex items-center text-slate-500 text-xs gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i><span class="truncate w-24">{{ event.location }}</span></div>
                                <div class="flex gap-2">
                                    <button @click="toggleComments(event.id)" class="flex items-center gap-1 px-2 py-1.5 rounded-full hover:bg-slate-50 transition-colors relative shadow-sm" :class="openCommentId === event.id ? 'bg-white text-[#5D6F80]' : 'bg-white/80 text-slate-500'"><i data-lucide="message-circle" class="w-3.5 h-3.5"></i><span v-if="event.comments && event.comments.length > 0" class="text-[10px] font-bold">{{ event.comments.length }}</span></button>
                                    <button @click="editEvent(event)" class="p-1.5 rounded-full bg-white/80 hover:bg-white text-slate-500 transition-colors shadow-sm"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button>
                                    <a :href="getGoogleMapsLink(event.location)" target="_blank" class="flex items-center gap-1 bg-[#7CA1B3]/20 hover:bg-[#7CA1B3]/40 text-[#5D6F80] text-[10px] font-bold px-3 py-1.5 rounded-full transition-colors backdrop-blur-md">NAV</a>
                                </div>
                            </div>
                            <transition name="comment">
                                <div v-if="openCommentId === event.id" class="mt-3 pt-2 bg-white/40 -mx-4 -mb-4 px-4 pb-4 rounded-b-[24px] border-t border-white/50 shadow-inner">
                                    <div v-if="event.comments && event.comments.length > 0" class="space-y-3 mb-3 max-h-60 overflow-y-auto scrollbar-hide">
                                        <div v-for="comment in event.comments" :key="comment.id" class="flex gap-2 items-start text-xs group/item">
                                            <div class="w-7 h-7 rounded-full flex-shrink-0 flex items-center justify-center text-[12px] shadow-sm mt-0.5 border border-white/50" :class="getUser(comment.userId).bgColor">{{ getUser(comment.userId).avatar }}</div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-baseline mb-0.5 ml-1"><span class="font-bold" :class="getUser(comment.userId).textColor">{{ getUser(comment.userId).name }}</span><span class="text-[9px] text-slate-400 scale-90 origin-right">{{ formatTime(comment.timestamp) }}</span></div>
                                                <div v-if="editingCommentId === comment.id" class="flex gap-1 items-center mb-1">
                                                    <input v-model="editingCommentText" class="flex-1 bg-white border border-blue-300 rounded px-2 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-200" @keyup.enter="saveCommentEdit(event, comment)" ref="editInput">
                                                    <button @click="saveCommentEdit(event, comment)" class="text-green-600 p-1.5 bg-green-100 rounded hover:bg-green-200"><i data-lucide="check" class="w-3.5 h-3.5"></i></button>
                                                    <button @click="cancelEditComment" class="text-slate-500 p-1.5 bg-slate-100 rounded hover:bg-slate-200"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                                </div>
                                                <div v-else class="text-slate-700 p-2.5 rounded-2xl shadow-sm relative pr-12 min-w-[80px] break-words transition-colors" :class="getCommentStyle(comment.userId)">
                                                    {{ comment.text }}
                                                    <div v-if="comment.userId === currentUser.id" class="absolute top-1 right-1 flex gap-1 bg-white rounded-full px-1.5 py-0.5 shadow-sm border border-slate-100">
                                                        <button @click="startEditComment(comment)" class="text-slate-400 hover:text-blue-600 p-0.5"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                                        <button @click="deleteComment(event, comment.id)" class="text-slate-400 hover:text-red-500 p-0.5"><i data-lucide="trash" class="w-3 h-3"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-4 text-[10px] text-slate-400 italic">No comments yet.</div>
                                    <div class="flex gap-2 items-center mt-2 pt-2 border-t border-slate-200/50">
                                        <div class="w-7 h-7 rounded-full flex items-center justify-center text-[12px] opacity-80 shadow-sm border border-white" :class="currentUser.bgColor">{{ currentUser.avatar }}</div>
                                        <input v-model="newCommentTexts[event.id]" placeholder="Write a comment..." class="flex-1 bg-white/80 border border-slate-200 rounded-full px-3 py-2 text-base focus:ring-2 focus:ring-[#7CA1B3]/50 focus:outline-none placeholder:text-slate-400" @keyup.enter="addComment(event)">
                                        <button @click="addComment(event)" class="text-white bg-[#5D6F80] hover:bg-[#4A5A6A] p-2 rounded-full shadow-md transition-transform active:scale-95"><i data-lucide="send" class="w-3.5 h-3.5"></i></button>
                                    </div>
                                </div>
                            </transition>
                        </div>
                    </div>
                </div>
                <div class="h-8"></div>
            </div>

            <!-- SPLIT BILL TAB -->
            <div v-else class="space-y-6 pt-2">
                 <div class="bg-gradient-to-br from-[#7CA1B3] to-[#5D6F80] rounded-[2rem] p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start">
                        <div><h2 class="text-xl font-serif italic mb-1 opacity-90">Total Expenses</h2><p class="text-3xl font-bold mb-6 tracking-tight">{{ formatMoney(totalExpense) }}</p></div>
                        <button @click="resetExpenses" class="text-xs text-white/50 hover:text-white underline">Reset</button>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-md border border-white/20">
                        <h3 class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-3 text-blue-50">Settlement</h3>
                        <ul class="space-y-2 text-sm">
                            <li v-for="debt in settlements" :key="debt.id" class="flex justify-between items-center border-b border-white/10 pb-2 last:border-0 last:pb-0">
                                <span class="flex items-center gap-2"><span class="px-2 py-0.5 rounded-md bg-white/20 text-xs font-bold">{{ debt.from }}</span><i data-lucide="arrow-right" class="w-3 h-3 opacity-50"></i><span class="px-2 py-0.5 rounded-md bg-white/20 text-xs font-bold">{{ debt.to }}</span></span><span class="font-bold text-white">{{ formatMoney(debt.amount) }}</span>
                            </li>
                            <li v-if="settlements.length === 0" class="text-center opacity-60 text-xs italic">All settled up!</li>
                        </ul>
                    </div>
                </div>
                <div class="glass-card rounded-[20px] p-5">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2 text-sm"><div class="p-1 bg-emerald-100/50 rounded-md text-emerald-600"><i data-lucide="plus" class="w-3 h-3"></i></div>New Expense</h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.item" placeholder="What for?" class="w-full bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50">
                        <div class="flex gap-3">
                            <input v-model.number="newExpense.amount" type="number" placeholder="Amount" class="w-1/2 bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50">
                            <select v-model="newExpense.payer" class="w-1/2 bg-white/50 border border-slate-200/60 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#7CA1B3]/50">
                                <option value="" disabled>Payer</option>
                                <option v-for="u in users" :key="u.id" :value="u.name">{{ u.name }}</option>
                            </select>
                        </div>
                        <button @click="addExpense" class="w-full bg-[#5D6F80] hover:bg-[#4A5A6A] text-white rounded-xl py-3 text-sm font-bold transition-all shadow-lg shadow-slate-300/50">Add Record</button>
                    </div>
                </div>
                <div class="pb-8">
                    <h3 class="text-xs font-bold text-slate-400 px-4 mb-2 uppercase tracking-wider">History ({{ expenses.length }})</h3>
                    <div class="space-y-2">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="glass-card px-4 py-3 rounded-xl flex justify-between items-center mx-1 group">
                            <div><div class="font-bold text-sm text-slate-700">{{ exp.item }}</div><div class="text-[10px] text-slate-500 font-medium bg-slate-100/50 px-2 py-0.5 rounded-full inline-block mt-1">{{ exp.payer }} paid</div></div>
                            <div class="flex items-center gap-3"><div class="font-bold text-slate-600 text-sm">{{ formatMoney(exp.amount) }}</div><button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="x" class="w-3 h-3"></i></button></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Buttons & Nav -->
        <button v-if="currentTab === 'trip'" @click="openModal()" class="absolute bottom-24 right-6 w-14 h-14 bg-[#5D6F80] text-white rounded-full shadow-[0_8px_30px_rgb(93,111,128,0.4)] flex items-center justify-center hover:scale-105 transition-all z-20 border border-white/20 backdrop-blur-sm"><i data-lucide="plus" class="w-6 h-6"></i></button>
        <nav class="absolute bottom-0 w-full glass-header flex justify-around items-center h-20 pb-2 z-30 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
            <button @click="currentTab = 'trip'" class="flex flex-col items-center gap-1 w-20 group"><div class="p-1.5 rounded-2xl transition-all duration-300 relative"><div class="absolute inset-0 bg-[#7CA1B3]/20 blur-md rounded-full opacity-0 group-hover:opacity-100 transition-opacity" v-if="currentTab === 'trip'"></div><i data-lucide="map" class="w-5 h-5 relative z-10" :class="currentTab === 'trip' ? 'text-[#5D6F80] fill-[#5D6F80]/20' : 'text-slate-400'"></i></div><span class="text-[9px] font-bold tracking-widest transition-colors" :class="currentTab === 'trip' ? 'text-[#5D6F80]' : 'text-slate-400'">ITINERARY</span></button>
            <button @click="currentTab = 'split'" class="flex flex-col items-center gap-1 w-20 group"><div class="p-1.5 rounded-2xl transition-all duration-300 relative"><div class="absolute inset-0 bg-[#7CA1B3]/20 blur-md rounded-full opacity-0 group-hover:opacity-100 transition-opacity" v-if="currentTab === 'split'"></div><i data-lucide="wallet" class="w-5 h-5 relative z-10" :class="currentTab === 'split' ? 'text-[#5D6F80] fill-[#5D6F80]/20' : 'text-slate-400'"></i></div><span class="text-[9px] font-bold tracking-widest transition-colors" :class="currentTab === 'split' ? 'text-[#5D6F80]' : 'text-slate-400'">EXPENSES</span></button>
        </nav>

        <!-- Edit/New Modal -->
        <transition name="modal">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="closeModal"></div><div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white"><h3 class="text-xl font-serif italic font-bold mb-6 text-[#5D6F80]">{{ isEditing ? 'Edit Plan' : 'New Plan' }}</h3><div class="space-y-4"><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Time</label><input type="time" v-model="form.time" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"></div><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Activity</label><input type="text" v-model="form.title" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"></div><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Location</label><input type="text" v-model="form.location" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"></div><div><label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 tracking-wider">Type</label><select v-model="form.typeLabel" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-slate-700 focus:ring-2 focus:ring-[#7CA1B3]/30"><option>FLIGHT</option><option>HOTEL</option><option>FOOD</option><option>ACTIVITY</option><option>SHOPPING</option></select></div></div><div class="flex gap-3 mt-8"><button @click="closeModal" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold hover:bg-slate-200 transition-colors">Cancel</button><button @click="saveEvent" class="flex-1 py-3 rounded-xl bg-[#5D6F80] text-white font-bold hover:bg-[#4A5A6A] shadow-lg shadow-slate-400/30 transition-all">Save</button></div></div></div>
        </transition>

        <!-- User Modal -->
        <transition name="modal">
            <div v-if="showUserModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-[#334155]/30 backdrop-blur-sm transition-opacity" @click="showUserModal = false"></div>
                <div class="bg-[#F8FAFC] w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all border border-white max-h-[90vh] overflow-y-auto scrollbar-hide">
                    <h3 class="text-xl font-serif italic font-bold mb-4 text-[#5D6F80]">Who are you?</h3>
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <button v-for="u in users" :key="u.id" @click="switchUser(u)" class="flex flex-col items-center gap-2 p-3 rounded-2xl border transition-all" :class="currentUser.id === u.id ? 'bg-white border-[#5D6F80]/30 shadow-md ring-2 ring-[#5D6F80]/20' : 'border-transparent hover:bg-white/50'">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg shadow-sm" :class="u.bgColor">{{ u.avatar }}</div>
                            <span class="text-xs font-bold text-slate-600 truncate w-full text-center">{{ u.name }}</span>
                        </button>
                    </div>
                    <div class="border-t border-slate-200 my-4"></div>
                    <h4 class="text-sm font-bold text-slate-500 mb-3">Or create new user</h4>
                    <div class="space-y-4">
                        <input v-model="newUser.name" placeholder="Your Name" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#5D6F80]/20">
                        <div class="flex gap-3 items-center">
                            <span class="text-xs text-slate-400 font-bold uppercase w-12 flex-shrink-0">Avatar</span>
                            <div class="flex gap-2 overflow-x-auto p-1 scrollbar-hide -mx-1 px-1">
                                <button v-for="emoji in avatarOptions" :key="emoji" @click="newUser.avatar = emoji" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center hover:bg-white border border-transparent hover:border-slate-200 transition-colors flex-shrink-0" :class="{'ring-2 ring-[#5D6F80]': newUser.avatar === emoji}">{{ emoji }}</button>
                            </div>
                        </div>
                        <div class="flex gap-3 items-center">
                            <span class="text-xs text-slate-400 font-bold uppercase w-12 flex-shrink-0">Color</span>
                            <div class="flex gap-2 overflow-x-auto p-1 scrollbar-hide -mx-1 px-1">
                                <button v-for="(color, idx) in colorOptions" :key="idx" @click="setNewUserColor(color)" class="w-6 h-6 rounded-full border border-slate-200/50 shadow-sm flex-shrink-0" :class="[color.bg, {'ring-2 ring-offset-2 ring-slate-400': newUser.bgColor === color.bg}]"></button>
                            </div>
                        </div>
                        <button @click="createUser" class="w-full py-3 rounded-xl bg-[#5D6F80] text-white font-bold hover:bg-[#4A5A6A] shadow-lg shadow-slate-400/30 mt-2 transition-all">Create & Login</button>
                    </div>
                    <div class="mt-4 text-center"><button @click="showUserModal = false" class="text-xs text-slate-400 underline">Close</button></div>
                </div>
            </div>
        </transition>

        <!-- âœ¨ AI Assistant Modal -->
        <transition name="modal">
            <div v-if="showAIModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-[#334155]/60 backdrop-blur-md transition-opacity" @click="showAIModal = false"></div>
                <div class="ai-card w-full max-w-sm rounded-[32px] p-6 relative shadow-2xl z-50 transform transition-all overflow-hidden flex flex-col max-h-[85vh]">
                    
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-indigo-100 rounded-full text-indigo-600">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">AI æ—…éŠé¡§å•</h3>
                                <p class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Powered by Gemini</p>
                            </div>
                        </div>
                        <button @click="showAIModal = false" class="p-2 bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- API Key Setup (If missing) -->
                    <div v-if="!apiKey" class="flex-1 flex flex-col justify-center text-center space-y-4">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-300">
                            <i data-lucide="key" class="w-8 h-8"></i>
                        </div>
                        <h4 class="font-bold text-slate-700">éœ€è¦ API é‡‘é‘°</h4>
                        <p class="text-xs text-slate-500 px-4">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key ä»¥å•Ÿç”¨ AI åŠŸèƒ½ã€‚é‡‘é‘°å°‡åƒ…å„²å­˜åœ¨æ‚¨çš„æ‰‹æ©Ÿä¸­ã€‚</p>
                        <input v-model="tempApiKey" placeholder="è²¼ä¸Š API Key..." class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500/50">
                        <button @click="saveApiKey" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">
                            å•Ÿç”¨ AI åŠŸèƒ½
                        </button>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-500 underline mt-2">å–å¾—å…è²» Key</a>
                    </div>

                    <!-- AI Interface -->
                    <div v-else class="flex flex-col h-full overflow-hidden">
                        
                        <!-- Tabs -->
                        <div class="flex p-1 bg-slate-100/80 rounded-xl mb-4 overflow-x-auto scrollbar-hide gap-1">
                            <button @click="aiTab = 'itinerary'" class="flex-1 whitespace-nowrap py-2 text-xs font-bold rounded-lg transition-all" :class="aiTab === 'itinerary' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-400'">è¡Œç¨‹å»ºè­°</button>
                            <button @click="aiTab = 'thai'" class="flex-1 whitespace-nowrap py-2 text-xs font-bold rounded-lg transition-all" :class="aiTab === 'thai' ? 'bg-white text-pink-600 shadow-sm' : 'text-slate-400'">æ³°èªå¹«æ‰‹</button>
                            <!-- Smart Planner Tab (Admin Only) -->
                            <button v-if="currentUser.isAdmin" @click="aiTab = 'planner'" class="flex-1 whitespace-nowrap py-2 text-xs font-bold rounded-lg transition-all" :class="aiTab === 'planner' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'">æ™ºæ…§æ’ç¨‹</button>
                        </div>

                        <!-- Tab 1: Itinerary Advisor -->
                        <div v-if="aiTab === 'itinerary'" class="flex-1 overflow-y-auto scrollbar-hide space-y-4">
                            <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100">
                                <p class="text-xs text-indigo-800 font-medium mb-1">ğŸ“… {{ dates.find(d=>d.fullDate===selectedDate).monthStr }} çš„è¡Œç¨‹</p>
                                <p class="text-xs text-slate-500">AI å°‡åˆ†æä»Šæ—¥å®‰æ’ï¼Œæä¾›äº¤é€šå»ºè­°æˆ–é™„è¿‘éš±è—æ™¯é»ã€‚</p>
                            </div>
                            
                            <div v-if="aiLoading" class="py-8 text-center space-y-3">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                                <p class="text-xs text-indigo-500 font-bold animate-pulse">AI æ­£åœ¨æ€è€ƒä¸­...</p>
                            </div>

                            <div v-else-if="aiResponse" class="prose prose-sm max-w-none text-slate-600 text-xs bg-white p-4 rounded-2xl border border-slate-100 shadow-sm" v-html="parsedAiResponse"></div>

                            <button v-if="!aiLoading" @click="analyzeItinerary" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold shadow-lg shadow-indigo-200 hover:scale-[1.02] transition-transform flex items-center justify-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4"></i> åˆ†æä»Šæ—¥è¡Œç¨‹
                            </button>
                        </div>

                        <!-- Tab 2: Thai Translator + TTS -->
                        <div v-if="aiTab === 'thai'" class="flex-1 overflow-y-auto scrollbar-hide space-y-4">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-slate-500 uppercase">æˆ‘æƒ³èªª...</label>
                                <textarea v-model="thaiInput" placeholder="ä¾‹å¦‚ï¼šä¸è¦é¦™èœã€å»æ‰€åœ¨å“ªè£¡ï¼Ÿ" class="w-full h-20 bg-white border border-slate-200 rounded-2xl p-3 text-sm focus:ring-2 focus:ring-pink-500/50 focus:outline-none resize-none"></textarea>
                            </div>

                            <button @click="translateToThai" :disabled="!thaiInput || aiLoading" class="w-full py-3 rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold shadow-lg shadow-pink-200 hover:scale-[1.02] transition-transform flex items-center justify-center gap-2 disabled:opacity-50">
                                <span v-if="aiLoading" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                                <span v-else><i data-lucide="languages" class="w-4 h-4 inline mr-1"></i> ç¿»è­¯ä¸¦æ’­æ”¾</span>
                            </button>

                            <div v-if="thaiResult" class="bg-white p-4 rounded-2xl border border-pink-100 shadow-sm space-y-3 relative overflow-hidden">
                                <div class="absolute top-0 right-0 p-2 opacity-10 text-pink-500"><i data-lucide="mic" class="w-16 h-16"></i></div>
                                <div>
                                    <p class="text-2xl font-bold text-slate-800 mb-1">{{ thaiResult.thai }}</p>
                                    <p class="text-sm text-pink-600 font-medium">{{ thaiResult.pronunciation }}</p>
                                    <p class="text-xs text-slate-400 mt-2 border-t border-slate-100 pt-2">{{ thaiResult.meaning }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="playAudio(thaiResult.audioData)" class="flex-1 py-2 bg-pink-50 text-pink-600 rounded-lg text-xs font-bold hover:bg-pink-100 flex items-center justify-center gap-1">
                                        <i data-lucide="volume-2" class="w-4 h-4"></i> æ’­æ”¾èªéŸ³
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 3: Smart Planner (Admin Only) -->
                        <div v-if="aiTab === 'planner'" class="flex-1 overflow-y-auto scrollbar-hide space-y-4">
                            <div class="bg-emerald-50/50 p-3 rounded-2xl border border-emerald-100 text-xs text-slate-600">
                                <p class="font-bold text-emerald-800 mb-1">ğŸ¤– AI è‡ªå‹•æ’ç¨‹ (Beta)</p>
                                <p>è²¼ä¸Šæ–‡å­—è¡Œç¨‹ï¼ˆå¦‚ã€Œ12/29 æ—©ä¸Š9é»å¤§çš‡å®®...ã€ï¼‰ï¼ŒAI å°‡è‡ªå‹•è½‰æ›ç‚º App è¡Œç¨‹å¡ç‰‡ã€‚</p>
                            </div>

                            <div class="space-y-3">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">æ›´æ–°ç¯„åœ</label>
                                    <select v-model="smartPlanScope" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-xs focus:outline-none">
                                        <option value="all">æ•´è¶Ÿæ—…ç¨‹ (è‡ªå‹•åµæ¸¬æ—¥æœŸ)</option>
                                        <option :value="selectedDate">åƒ…æ›´æ–°ç›®å‰é¸æ“‡æ—¥æœŸ ({{ selectedDate }})</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">æ›´æ–°æ¨¡å¼</label>
                                    <div class="flex gap-2">
                                        <button @click="smartPlanAction = 'append'" class="flex-1 py-2 rounded-lg border text-xs font-bold transition-all" :class="smartPlanAction === 'append' ? 'bg-emerald-100 border-emerald-300 text-emerald-700' : 'bg-white border-slate-200 text-slate-400'">
                                            è¿½åŠ  (ä¿ç•™èˆŠè¡Œç¨‹)
                                        </button>
                                        <button @click="smartPlanAction = 'replace'" class="flex-1 py-2 rounded-lg border text-xs font-bold transition-all" :class="smartPlanAction === 'replace' ? 'bg-red-50 border-red-200 text-red-600' : 'bg-white border-slate-200 text-slate-400'">
                                            è¦†è“‹ (æ¸…ç©ºè©²æ—¥èˆŠè¡Œç¨‹)
                                        </button>
                                    </div>
                                </div>

                                <textarea v-model="smartPlanInput" placeholder="åœ¨æ­¤è²¼ä¸Šè¡Œç¨‹æ–‡å­—..." class="w-full h-32 bg-white border border-slate-200 rounded-xl p-3 text-xs focus:ring-2 focus:ring-emerald-500/50 focus:outline-none resize-none"></textarea>
                            </div>

                            <button @click="generateItineraryFromText" :disabled="!smartPlanInput || aiLoading" class="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold shadow-lg shadow-emerald-200 hover:scale-[1.02] transition-transform flex items-center justify-center gap-2 disabled:opacity-50">
                                <span v-if="aiLoading" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                                <span v-else><i data-lucide="wand-2" class="w-4 h-4 inline mr-1"></i> AI ç”Ÿæˆä¸¦æ›´æ–°</span>
                            </button>
                            
                            <p v-if="aiResponse" class="text-[10px] text-emerald-600 text-center animate-pulse">{{ aiResponse }}</p>
                        </div>

                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- Firebase SDKs & App Logic -->
    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // -----------------------------------------------------------
        // ğŸ”´ è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ Firebase Config
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB9jFPE0kv9HsCpdhMZpKv39eOmgxWJtxs",
            authDomain: "tripapp-v01.firebaseapp.com",
            projectId: "tripapp-v01",
            storageBucket: "tripapp-v01.firebasestorage.app",
            messagingSenderId: "807025775834",
            appId: "1:807025775834:web:d8dc610815cd0b52abc1e3"
        };

        createApp({
            setup() {
                // Check if config is present
                const firebaseConfigured = ref(Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_API_KEY");
                const isLoading = ref(true);
                const loadingStatus = ref("Connecting to Cloud...");
                const loadingError = ref("");
                let db = null;
                let auth = null;
                const TRIP_DOC_ID = 'bangkok2025_trip_data'; // The ID in Firestore
                const isRemoteUpdate = ref(false); // Flag to prevent infinite loop
                let saveTimeout = null; // For debouncing
                const USER_STORAGE_KEY = 'bangkok_trip_current_user_id'; // LocalStorage Key

                // --- Default Data ---
                const defaultEvents = [
                    { id: 101, date: '2025-12-27', time: '03:30', title: 'æ©Ÿå ´æ¥é€å‰å¾€æ©Ÿå ´', location: 'å°ç£ä½å®¶', typeLabel: 'FLIGHT', desc: 'é ç´„æ™‚é–“ AM 3:30', comments: [] },
                    { id: 102, date: '2025-12-27', time: '07:00', title: 'æ­ä¹˜ä¸­è¯èˆªç©º CI833 èµ·é£›', location: 'TPE Airport', typeLabel: 'FLIGHT', comments: [] },
                    { id: 103, date: '2025-12-27', time: '09:50', title: 'æŠµé”æ›¼è°·ï¼Œè¾¦ç†å…¥å¢ƒèˆ‡é ˜è¡Œæ', location: 'BKK Airport', typeLabel: 'FLIGHT', comments: [] },
                    { id: 104, date: '2025-12-27', time: '11:00', title: 'æ©Ÿå ´å¿«ç·š ARL è½‰ BTS', location: 'ARL Phaya Thai è½‰ BTS Nana', typeLabel: 'ACTIVITY', desc: 'ç´„ 60 åˆ†é˜è»Šç¨‹', comments: [] },
                    { id: 105, date: '2025-12-27', time: '12:30', title: 'é£¯åº— Check-in / å¯„æ”¾è¡Œæ', location: 'PARKROYAL Serviced Suites Bangkok', typeLabel: 'HOTEL', desc: 'ä½æ–¼ Sukhumvit Soi 6', comments: [] },
                    { id: 106, date: '2025-12-27', time: '14:30', title: 'The Prime Massage (å¿…å»è¡Œç¨‹)', location: 'Silom (BTS Sala Daeng)', typeLabel: 'ACTIVITY', desc: 'è¨˜å¾—é ç´„å¾ŒçºŒæŒ‰æ‘©', comments: [] },
                    { id: 107, date: '2025-12-27', time: '18:00', title: 'æ™šé¤ï¼šJodd Fairs ç«å±±æ’éª¨', location: 'Jodd Fairs å¤œå¸‚', typeLabel: 'FOOD', comments: [] },
                    { id: 201, date: '2025-12-28', time: '10:00', title: 'æ°åœ–æ°é€±æœ«å¸‚é›†å°‹å¯¶', location: 'Chatuchak Market', typeLabel: 'SHOPPING', desc: 'è¨˜å¾—é ç•™ç§»å‹•æ™‚é–“', comments: [] },
                    { id: 202, date: '2025-12-28', time: '13:00', title: 'é›¢é–‹å¸‚é›†ï¼Œå‰å¾€ Samyan', location: 'Transit', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 203, date: '2025-12-28', time: '14:00', title: 'MY ONLY FRAGRANCE èª¿é¦™é«”é©—', location: 'Chula 14 (Yung-Kun Chang)', typeLabel: 'ACTIVITY', desc: 'å·²é ç´„ 2ä½', comments: [] },
                    { id: 204, date: '2025-12-28', time: '16:00', title: 'é€› Samyan Mitrtown / æœ±æ‹‰éš†åŠŸå‘¨é‚Š', location: 'Samyan', typeLabel: 'SHOPPING', comments: [] },
                    { id: 205, date: '2025-12-28', time: '19:00', title: 'Ari æ–‡é’å€æ™šé¤ & å’–å•¡å»³', location: 'Ari Area', typeLabel: 'FOOD', comments: [] },
                    { id: 301, date: '2025-12-29', time: '09:00', title: 'å¤§çš‡å®® & ç‰ä½›å¯º (Grand Palace)', location: 'Old City', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 302, date: '2025-12-29', time: '12:00', title: 'ç¢¼é ­é‚Šåˆé¤ï¼šç±³å…¶æ—æ¨è–¦', location: 'Tha Tien (å¦‚ Krua Apsorn)', typeLabel: 'FOOD', comments: [] },
                    { id: 303, date: '2025-12-29', time: '14:00', title: 'è‡¥ä½›å¯º (Wat Pho) åƒè§€', location: 'Wat Pho', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 304, date: '2025-12-29', time: '17:00', title: 'æ­èˆ¹å»é„­ç‹å»Ÿçœ‹æ—¥è½', location: 'Wat Arun', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 305, date: '2025-12-29', time: '19:00', title: 'IconSiam åƒæ™šé¤', location: 'IconSiam', typeLabel: 'FOOD', desc: 'æ­æ¥é§èˆ¹å‰å¾€', comments: [] },
                    { id: 401, date: '2025-12-30', time: '09:00', title: 'å®¤å…§æ°´ä¸Šå¸‚å ´æ—©é¤ / é–’é€›', location: 'IconSiam', typeLabel: 'FOOD', comments: [] },
                    { id: 402, date: '2025-12-30', time: '12:00', title: 'Siam Paragon / Central World é€›è¡—', location: 'Siam å•†åœˆ', typeLabel: 'SHOPPING', comments: [] },
                    { id: 403, date: '2025-12-30', time: '15:00', title: '(é¸) æµ·æ´‹ä¸–ç•Œæˆ–è Ÿåƒé¤¨', location: 'Sea Life / Madame Tussauds', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 404, date: '2025-12-30', time: '19:00', title: 'é«˜ç©ºé…’å§çœ‹å¤œæ™¯', location: 'Red Sky Bar', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 501, date: '2025-12-31', time: '11:00', title: 'ç¶²ç¾å’–å•¡å»³æ—©åˆé¤', location: 'Bubble in the forest', typeLabel: 'FOOD', comments: [] },
                    { id: 502, date: '2025-12-31', time: '15:00', title: 'å›é£¯åº—åˆç¡è£œçœ ', location: 'PARKROYAL Hotel', typeLabel: 'HOTEL', desc: 'å„²å‚™è·¨å¹´é«”åŠ›', comments: [] },
                    { id: 503, date: '2025-12-31', time: '19:00', title: 'è·¨å¹´å¤§é¤', location: 'Rooftop / Riverside', typeLabel: 'FOOD', comments: [] },
                    { id: 504, date: '2025-12-31', time: '23:00', title: 'å‰å¾€å€’æ•¸', location: 'Central World / Iconsiam', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 505, date: '2025-12-31', time: '23:59', title: 'HAPPY NEW YEAR 2026!', location: 'Bangkok', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 601, date: '2026-01-01', time: '11:00', title: 'åƒæ‹œå››é¢ä½› (Erawan Shrine)', location: 'Erawan', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 602, date: '2026-01-01', time: '13:00', title: 'åˆé¤ï¼šOpen House æ›¸åº—', location: 'Central Embassy', typeLabel: 'FOOD', comments: [] },
                    { id: 603, date: '2026-01-01', time: '15:00', title: 'å…¨èº«ç²¾æ²¹ SPA', location: 'Let\'s Relax / Health Land', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 604, date: '2026-01-01', time: '18:00', title: 'æœ±æ‹‰éš†åŠŸå¤§å­¸ç¾é£Ÿè¡—è¦“é£Ÿ', location: 'Ban Tad Thong', typeLabel: 'FOOD', comments: [] },
                    { id: 701, date: '2026-01-02', time: '10:00', title: 'é€›æœ€æ–°æ½®å•†å ´ Emsphere', location: 'Emsphere / EmQuartier', typeLabel: 'SHOPPING', comments: [] },
                    { id: 702, date: '2026-01-02', time: '14:00', title: 'Big C æ¡è²·ä¼´æ‰‹ç¦®', location: 'Big C Supercenter', typeLabel: 'SHOPPING', comments: [] },
                    { id: 703, date: '2026-01-02', time: '17:00', title: 'å›é£¯åº—æ”¾æˆ°åˆ©å“ / æ•´ç†è¡Œæ', location: 'Hotel', typeLabel: 'HOTEL', comments: [] },
                    { id: 704, date: '2026-01-02', time: '19:00', title: 'å”äººè¡—æµ·é®®å¤§æ’æª”', location: 'Yaowarat (Chinatown)', typeLabel: 'FOOD', comments: [] },
                    { id: 801, date: '2026-01-03', time: '10:00', title: 'ç¡åˆ°è‡ªç„¶é†’ï¼Œé£¯åº—æ—©é¤', location: 'Hotel', typeLabel: 'HOTEL', comments: [] },
                    { id: 802, date: '2026-01-03', time: '12:00', title: 'æœ€å¾Œä¸€æ¬¡æŒ‰æ‘©æˆ–é€› Outlet', location: 'Massage / Outlet', typeLabel: 'ACTIVITY', comments: [] },
                    { id: 803, date: '2026-01-03', time: '14:30', title: 'å‰å¾€è˜‡å‡¡ç´å¸ƒæ©Ÿå ´', location: 'BKK Airport', typeLabel: 'FLIGHT', desc: 'CI836 17:50èµ·é£›', comments: [] },
                    { id: 804, date: '2026-01-03', time: '17:50', title: 'æ­æ©Ÿè¿”å°ï¼ŒçµæŸç¾å¥½æ—…ç¨‹', location: 'On Flight', typeLabel: 'FLIGHT', comments: [] },
                ];
                
                const defaultExpenses = [
                    { item: 'Airport Van', amount: 1200, payer: 'Alex' }, 
                    { item: 'Dinner Day 1', amount: 3000, payer: 'Me' }
                ];

                // Data Refs (Init first)
                const currentTab = ref('trip');
                const users = ref([
                    { id: 'admin', name: 'ç®¡ç†è€…', avatar: 'ğŸ›¡ï¸', bgColor: 'bg-white/80', textColor: 'text-slate-900', isAdmin: true },
                    { id: 'u1', name: 'Me', avatar: 'ğŸ˜', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' },
                    { id: 'u2', name: 'Alex', avatar: 'ğŸ§¢', bgColor: 'bg-emerald-100', textColor: 'text-emerald-600' }
                ]);
                const currentUser = ref(users.value[0]); // Default to Admin
                
                // Initialize with defaults (Important for first load)
                const events = ref([...defaultEvents]);
                const expenses = ref([...defaultExpenses]);

                // Init Firebase
                if(firebaseConfigured.value) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                    } catch(e) { 
                        console.error("Firebase init error:", e);
                        loadingError.value = "Init Failed: " + e.message;
                    }
                }

                
                // --- Dates ---
                const dates = ref([
                    { fullDate: '2025-12-27', monthStr: '12/27', dayNum: '27', weekDay: 'SAT' },
                    { fullDate: '2025-12-28', monthStr: '12/28', dayNum: '28', weekDay: 'SUN' },
                    { fullDate: '2025-12-29', monthStr: '12/29', dayNum: '29', weekDay: 'MON' },
                    { fullDate: '2025-12-30', monthStr: '12/30', dayNum: '30', weekDay: 'TUE' },
                    { fullDate: '2025-12-31', monthStr: '12/31', dayNum: '31', weekDay: 'WED' },
                    { fullDate: '2026-01-01', monthStr: '01/01', dayNum: '01', weekDay: 'THU' },
                    { fullDate: '2026-01-02', monthStr: '01/02', dayNum: '02', weekDay: 'FRI' },
                    { fullDate: '2026-01-03', monthStr: '01/03', dayNum: '03', weekDay: 'SAT' },
                ]);
                const selectedDate = ref('2025-12-27');

                // --- Sync Logic (The Magic) ---
                const saveDataToCloud = async () => {
                    if(!db) return;
                    try {
                        await setDoc(doc(db, "trips", TRIP_DOC_ID), {
                            events: events.value,
                            expenses: expenses.value,
                            users: users.value,
                            lastUpdated: new Date().toISOString()
                        });
                    } catch(e) { 
                        console.error("Save failed", e); 
                        if(e.code === 'resource-exhausted') {
                            loadingError.value = "Firebase æ¯æ—¥é¡åº¦å·²ç”¨å®Œ (Quota Exceeded)ã€‚è«‹ç­‰å¾…æ˜æ—¥é‡ç½®æˆ–å‡ç´šæ–¹æ¡ˆã€‚";
                        }
                    }
                };

                // Debounced Save (Fix for write explosion)
                const debouncedSave = () => {
                    if (saveTimeout) clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveDataToCloud();
                    }, 1000);
                };

                // Helper to refresh icons manually after DOM updates
                const refreshIcons = () => {
                    setTimeout(() => {
                        lucide.createIcons();
                    }, 100);
                };

                // Watch for changes and save
                watch([events, expenses, users], () => {
                   if (isRemoteUpdate.value) {
                       return; // Ignore if update came from cloud
                   }
                   if(!isLoading.value) debouncedSave();
                }, { deep: true });

                const initFirebaseConnection = async () => {
                    if (!db || !auth) {
                        isLoading.value = false;
                        return;
                    }
                    
                    try {
                        loadingStatus.value = "Authenticating...";
                        await signInAnonymously(auth);
                        loadingStatus.value = "Syncing Data...";

                        const unsub = onSnapshot(doc(db, "trips", TRIP_DOC_ID), (doc) => {
                            isLoading.value = false;
                            if (doc.exists()) {
                                isRemoteUpdate.value = true; // Set flag
                                const data = doc.data();
                                if(data.events) events.value = data.events;
                                if(data.expenses) expenses.value = data.expenses;
                                if(data.users) users.value = data.users;
                                
                                // Restore User from LocalStorage after loading users
                                const savedUid = localStorage.getItem(USER_STORAGE_KEY);
                                if(savedUid) {
                                    const found = users.value.find(u => u.id === savedUid);
                                    if(found) currentUser.value = found;
                                }

                                nextTick(() => { isRemoteUpdate.value = false; refreshIcons(); }); 

                                // Fix for empty cloud data
                                if ((!data.events || data.events.length === 0) && defaultEvents.length > 0) {
                                     console.log("Cloud data empty, restoring defaults...");
                                     events.value = [...defaultEvents];
                                     expenses.value = [...defaultExpenses];
                                     debouncedSave();
                                }

                            } else {
                                // No data yet in cloud? Init with defaults and save
                                console.log("No cloud doc, initializing...");
                                isLoading.value = false;
                                debouncedSave();
                            }
                        }, (err) => {
                            console.error("Sync error:", err);
                            if(err.code === 'resource-exhausted') {
                                loadingError.value = "è®€å–å¤±æ•—ï¼šæ¯æ—¥é¡åº¦å·²ç”¨å®Œ (Quota Exceeded)ã€‚æš«æ™‚åˆ‡æ›ç‚ºé›¢ç·šæ¨¡å¼ã€‚";
                            } else {
                                loadingError.value = "Sync Error: " + err.message;
                            }
                        });

                    } catch (error) {
                        console.error("Auth failed:", error);
                        if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                            loadingError.value = "è«‹å» Firebase Console -> Authentication -> Sign-in method -> é–‹å•Ÿ 'Anonymous' (åŒ¿åç™»å…¥)";
                        } else {
                            loadingError.value = "Auth Failed: " + error.message;
                        }
                    }
                };

                // --- AI Functions (Analysis & Translation) ---
                const showAIModal = ref(false);
                const aiTab = ref('itinerary');
                const apiKey = ref(localStorage.getItem('gemini_api_key') || '');
                const tempApiKey = ref('');
                const aiLoading = ref(false);
                const aiResponse = ref('');
                const thaiInput = ref('');
                const thaiResult = ref(null);
                
                // --- Smart Planner Vars ---
                const smartPlanInput = ref('');
                const smartPlanScope = ref('all'); // 'all' or specific date string
                const smartPlanAction = ref('append'); // 'append' or 'replace'

                const saveApiKey = () => { if(tempApiKey.value) { localStorage.setItem('gemini_api_key', tempApiKey.value); apiKey.value = tempApiKey.value; } };
                const parsedAiResponse = computed(() => marked.parse(aiResponse.value));
                
                const analyzeItinerary = async () => {
                    if (!apiKey.value) return;
                    aiLoading.value = true; aiResponse.value = '';
                    const dayEvents = currentDayEvents.value.map(e => `${e.time} - ${e.title} @ ${e.location}`).join('\n');
                    const prompt = `Act as a local Bangkok guide. Here is my itinerary for today: \n${dayEvents}\n\n Please give me 2 specific, hidden gem suggestions (food or activity) that fit into this schedule logically. Also one logistical tip (transport/weather). Keep it concise, friendly, and use Traditional Chinese. Format with markdown bullet points.`;

                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey.value}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await res.json();
                        aiResponse.value = data.candidates?.[0]?.content?.parts?.[0]?.text || 'AI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚';
                    } catch (e) { aiResponse.value = "é€£ç·šéŒ¯èª¤ã€‚"; } finally { aiLoading.value = false; }
                };

                const generateItineraryFromText = async () => {
                    if (!apiKey.value || !smartPlanInput.value) return;
                    aiLoading.value = true;
                    aiResponse.value = "æ­£åœ¨åˆ†ææ‚¨çš„è¡Œç¨‹ä¸¦è½‰æ›æ ¼å¼...";

                    const targetDateStr = smartPlanScope.value === 'all' ? "Multiple dates possible" : selectedDate.value;
                    const prompt = `
                        System: You are an itinerary parser. The trip is in Bangkok, valid dates are 2025-12-27 to 2026-01-03.
                        Task: Convert the user's text into a JSON array of events.
                        User Input: "${smartPlanInput.value}"
                        Context Target Date: ${targetDateStr}. (If user input mentions specific dates, use them. If not, assume the target date).
                        
                        Output JSON schema: Array of objects. Each object must have:
                        - date: "YYYY-MM-DD"
                        - time: "HH:MM" (24hr format, e.g. 14:00)
                        - title: Short title (string)
                        - location: Location name (string)
                        - typeLabel: One of [FLIGHT, HOTEL, FOOD, ACTIVITY, SHOPPING] based on context.
                        - desc: Description or notes (string, optional)
                        
                        IMPORTANT: Output ONLY valid JSON array. No markdown, no explanations.
                    `;

                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey.value}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await res.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        // Clean markdown if present
                        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const newEvents = JSON.parse(jsonStr);

                        if (Array.isArray(newEvents)) {
                            // Process Events
                            const processedEvents = newEvents.map(e => ({
                                id: Date.now() + Math.floor(Math.random() * 10000), // Unique ID
                                userId: 'admin', // Created by AI/Admin
                                comments: [],
                                ...e
                            }));

                            // Apply logic based on Scope & Action
                            if (smartPlanScope.value === 'all') {
                                // For each date found in new events, handle replace/append
                                const datesToUpdate = [...new Set(processedEvents.map(e => e.date))];
                                
                                if (smartPlanAction.value === 'replace') {
                                    // Remove old events on these dates
                                    events.value = events.value.filter(e => !datesToUpdate.includes(e.date));
                                }
                                events.value.push(...processedEvents);
                            } else {
                                // Specific date mode
                                const target = selectedDate.value;
                                if (smartPlanAction.value === 'replace') {
                                    events.value = events.value.filter(e => e.date !== target);
                                }
                                // Force date to match target if AI guessed wrong or was vague
                                processedEvents.forEach(e => e.date = target);
                                events.value.push(...processedEvents);
                            }

                            aiResponse.value = `æˆåŠŸåŠ å…¥ ${processedEvents.length} å€‹è¡Œç¨‹ï¼`;
                            smartPlanInput.value = ''; // Clear input
                            refreshIcons();
                        } else {
                            throw new Error("Invalid JSON");
                        }

                    } catch (e) {
                        console.error(e);
                        aiResponse.value = "è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æˆ–ç¨å¾Œå†è©¦ã€‚";
                    } finally { aiLoading.value = false; }
                };

                // --- TTS & Translation ---
                const pcmToWav = (base64PCM) => {
                    const binaryString = atob(base64PCM);
                    const len = binaryString.length;
                    const buffer = new ArrayBuffer(44 + len);
                    const view = new DataView(buffer);
                    const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
                    
                    writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + len, true); writeString(view, 8, 'WAVE');
                    writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
                    view.setUint16(22, 1, true); view.setUint32(24, 24000, true); view.setUint32(28, 48000, true);
                    view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
                    view.setUint32(40, len, true);
                    
                    const pcmData = new Uint8Array(buffer, 44);
                    for (let i = 0; i < len; i++) pcmData[i] = binaryString.charCodeAt(i);
                    return new Blob([view], { type: 'audio/wav' });
                };

                const translateToThai = async () => {
                    if (!apiKey.value || !thaiInput.value) return;
                    aiLoading.value = true;
                    thaiResult.value = null;

                    // 1. Text Generation
                    const textPrompt = `Translate this to Thai for a tourist to say. Output ONLY valid JSON format: {"thai": "...", "pronunciation": "...", "meaning": "..."}. Phrase: "${thaiInput.value}"`;
                    
                    try {
                        // Parallel: Get Text info AND Audio
                        const textReq = fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey.value}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: textPrompt }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });

                        const resText = await textReq;
                        const dataText = await resText.json();
                        const jsonText = JSON.parse(dataText.candidates[0].content.parts[0].text);

                        // 2. Audio Generation (Using the Thai text from step 1)
                        const audioReq = fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey.value}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: jsonText.thai }] }],
                                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }
                            })
                        });

                        const resAudio = await audioReq;
                        const dataAudio = await resAudio.json();
                        const audioBase64 = dataAudio.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                        thaiResult.value = { ...jsonText, audioData: audioBase64 };

                    } catch (e) {
                        console.error(e);
                        alert("ç¿»è­¯å¤±æ•—ï¼Œè«‹ç¢ºèª API Key æˆ–ç¶²è·¯é€£ç·šã€‚");
                    } finally { aiLoading.value = false; }
                };

                const playAudio = (base64) => {
                    if(!base64) return;
                    const blob = pcmToWav(base64);
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    audio.play();
                };

                // Real-time Listener
                onMounted(() => {
                    lucide.createIcons();
                    fetchWeather();
                    initFirebaseConnection();
                });

                // --- Helpers & UI Logic (Same as before) ---
                const getDateButtonClass = (date) => {
                    const isSelected = selectedDate.value === date.fullDate;
                    if (isSelected) return 'bg-[#5D6F80] text-white shadow-lg shadow-slate-400/50 scale-105 border-transparent';
                    if (date.weekDay === 'SAT') return 'bg-[#D6E6D6]/60 text-[#5A7A5A] border-white/50 hover:bg-[#D6E6D6]';
                    if (date.weekDay === 'SUN') return 'bg-[#E6D6D6]/60 text-[#8A5A5A] border-white/50 hover:bg-[#E6D6D6]';
                    return 'bg-white/30 text-slate-500 border-white/40 hover:bg-white/50';
                };
                const getDotColor = (type) => {
                    const map = { 'FLIGHT': 'bg-blue-300', 'HOTEL': 'bg-indigo-300', 'FOOD': 'bg-amber-300', 'SHOPPING': 'bg-rose-300', 'ACTIVITY': 'bg-emerald-300' };
                    return map[type] || 'bg-slate-300';
                };
                const getGoogleMapsLink = (location) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location + ' Bangkok')}`;
                
                // ** Dynamic Style Logic **
                const getCardStyle = (uid) => {
                    if (!uid || uid === 'admin') return 'glass-card';
                    const u = getUser(uid);
                    // Use member color with high opacity but blur
                    return `member-card ${u.bgColor.replace('/80','').replace('/50','').replace('/20','')} bg-opacity-60`;
                };
                
                const getCommentStyle = (uid) => {
                    if (!uid || uid === 'admin') return 'bg-white/60';
                    const u = getUser(uid);
                    return `${u.bgColor.replace('/80','').replace('/50','').replace('/20','')} bg-opacity-40 border border-white/40`;
                };

                const currentDayEvents = computed(() => events.value.filter(e => e.date === selectedDate.value).sort((a, b) => a.time.localeCompare(b.time)));

                // User
                const newUser = ref({ name: '', avatar: 'ğŸ˜', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' });
                const avatarOptions = ['ğŸ˜', 'ğŸ§¢', 'ğŸŒ¸', 'ğŸ¸', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ¸', 'ğŸ¦„', 'ğŸ”', 'ğŸ•'];
                const colorOptions = [{ bg: 'bg-indigo-100', text: 'text-indigo-600' }, { bg: 'bg-emerald-100', text: 'text-emerald-600' }, { bg: 'bg-rose-100', text: 'text-rose-600' }, { bg: 'bg-amber-100', text: 'text-amber-600' }, { bg: 'bg-sky-100', text: 'text-sky-600' }, { bg: 'bg-purple-100', text: 'text-purple-600' }];
                const showUserModal = ref(false);
                const setNewUserColor = (c) => { newUser.value.bgColor = c.bg; newUser.value.textColor = c.text; };
                const createUser = () => { 
                    if(!newUser.value.name) return; 
                    const u = { id: 'u'+Date.now(), ...newUser.value }; 
                    users.value.push(u); 
                    currentUser.value = u; 
                    localStorage.setItem(USER_STORAGE_KEY, u.id); // Save user
                    newUser.value = { name: '', avatar: 'ğŸ˜', bgColor: 'bg-indigo-100', textColor: 'text-indigo-600' }; 
                    showUserModal.value = false; 
                };
                const switchUser = (u) => { 
                    currentUser.value = u; 
                    localStorage.setItem(USER_STORAGE_KEY, u.id); // Save user
                    showUserModal.value = false; 
                };
                const getUser = (id) => users.value.find(u => u.id === id) || { name: 'Unknown', avatar: '?', bgColor: 'bg-gray-100', textColor: 'text-gray-500' };

                // Comments
                const openCommentId = ref(null);
                const newCommentTexts = ref({});
                const editingCommentId = ref(null);
                const editingCommentText = ref("");

                const toggleComments = (id) => {
                    openCommentId.value = (openCommentId.value === id ? null : id);
                    refreshIcons(); // Force refresh when toggling
                };
                
                const addComment = (event) => {
                    const text = newCommentTexts.value[event.id];
                    if (!text) return;
                    if (!event.comments) event.comments = [];
                    event.comments.push({ id: Date.now(), userId: currentUser.value.id, text: text, timestamp: Date.now() });
                    newCommentTexts.value[event.id] = '';
                    refreshIcons(); // Force refresh on new comment
                };

                const startEditComment = (comment) => {
                    editingCommentId.value = comment.id;
                    editingCommentText.value = comment.text;
                    refreshIcons();
                };

                const saveCommentEdit = (event, comment) => {
                    if (editingCommentText.value.trim()) {
                        comment.text = editingCommentText.value;
                    }
                    editingCommentId.value = null;
                    editingCommentText.value = "";
                    refreshIcons();
                };

                const cancelEditComment = () => {
                    editingCommentId.value = null;
                    editingCommentText.value = "";
                    refreshIcons();
                };

                const deleteComment = (event, cid) => { 
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')) {
                        event.comments = event.comments.filter(c => c.id !== cid);
                        refreshIcons();
                    }
                };
                const formatTime = (ts) => { const d = new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`; };

                // Event Edit
                const showModal = ref(false);
                const isEditing = ref(false);
                const form = ref({});
                const openModal = () => { isEditing.value = false; form.value = { id: Date.now(), time: '12:00', title: '', location: '', typeLabel: 'ACTIVITY', desc: '', comments: [] }; showModal.value = true; };
                const editEvent = (evt) => { isEditing.value = true; form.value = JSON.parse(JSON.stringify(evt)); showModal.value = true; };
                const closeModal = () => showModal.value = false;
                const saveEvent = () => {
                    // Current User ID becomes the "Creator/Modifier" ID for coloring
                    const modifierId = currentUser.value.id;

                    if (isEditing.value) {
                        const idx = events.value.findIndex(e => e.id === form.value.id);
                        if (idx !== -1) {
                            events.value[idx] = { 
                                ...form.value, 
                                date: selectedDate.value, 
                                comments: events.value[idx].comments,
                                userId: modifierId // Update modifier
                            };
                        }
                    } else { 
                        events.value.push({ 
                            ...form.value, 
                            date: selectedDate.value, 
                            comments: [],
                            userId: modifierId // Set creator
                        }); 
                    }
                    closeModal();
                    refreshIcons(); // Force refresh on new/edit event
                };
                const deleteEvent = (id) => { 
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) {
                        events.value = events.value.filter(e => e.id !== id); 
                        refreshIcons();
                    }
                };

                // Expenses
                const newExpense = ref({ item: '', amount: '', payer: '' });
                const addExpense = () => { if(!newExpense.value.item || !newExpense.value.amount || !newExpense.value.payer) return; expenses.value.push({ ...newExpense.value }); newExpense.value = { item: '', amount: '', payer: '' }; refreshIcons(); };
                const removeExpense = (idx) => { expenses.value.splice(idx, 1); refreshIcons(); };
                const resetExpenses = () => { if(confirm('Reset?')) expenses.value = []; refreshIcons(); };
                const totalExpense = computed(() => expenses.value.reduce((sum, e) => sum + Number(e.amount), 0));
                const settlements = computed(() => {
                    let balances = {}; users.value.forEach(u => balances[u.name] = 0);
                    const activeUsers = users.value.map(u => u.name);
                    const splitAmount = totalExpense.value / (activeUsers.length || 1);
                    expenses.value.forEach(e => { if (balances[e.payer] !== undefined) balances[e.payer] += Number(e.amount); });
                    let debtors = [], creditors = [];
                    for (let u in balances) { const diff = balances[u] - splitAmount; if (diff < -0.01) debtors.push({ user: u, amount: -diff }); if (diff > 0.01) creditors.push({ user: u, amount: diff }); }
                    let results = [], i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let amount = Math.min(debtors[i].amount, creditors[j].amount);
                        if (amount > 0) results.push({ from: debtors[i].user, to: creditors[j].user, amount: Math.round(amount) });
                        debtors[i].amount -= amount; creditors[j].amount -= amount;
                        if (debtors[i].amount < 0.1) i++; if (creditors[j].amount < 0.1) j++;
                    }
                    return results;
                });
                const formatMoney = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
                
                // Weather
                const weatherData = ref({});
                const fetchWeather = async () => {
                     try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=13.7563&longitude=100.5018&daily=temperature_2m_max,weathercode&timezone=Asia%2FBangkok`); const data = await res.json(); const todayTemp = data.daily.temperature_2m_max[0]; const todayCode = data.daily.weathercode[0]; dates.value.forEach(d => { weatherData.value[d.fullDate] = { temp: Math.round(todayTemp + Math.floor(Math.random() * 3) - 1), code: todayCode }; }); } catch (e) {}
                };
                const getWeatherIcon = (code) => { if (code <= 3) return 'sun'; if (code <= 48) return 'cloud'; if (code <= 67) return 'cloud-rain'; return 'cloud-lightning'; };

                Vue.watch([currentTab, events, settlements, openCommentId, editingCommentId], () => {
                    nextTick(() => {
                        refreshIcons();
                    });
                }, { deep: true });

                return { 
                    firebaseConfigured, isLoading, loadingStatus, loadingError,
                    currentTab, dates, selectedDate, getDateButtonClass, getDotColor, currentDayEvents, 
                    users, currentUser, switchUser, createUser, newUser, showUserModal, avatarOptions, colorOptions, setNewUserColor, getUser,
                    events, deleteEvent, expenses, newExpense, addExpense, removeExpense, resetExpenses, totalExpense, settlements, formatMoney, 
                    showModal, openModal, closeModal, saveEvent, form, isEditing, 
                    weatherData, getWeatherIcon, toggleComments, openCommentId, addComment, newCommentTexts, deleteComment, formatTime, editEvent,
                    startEditComment, saveCommentEdit, cancelEditComment, editingCommentId, editingCommentText, getCardStyle, getCommentStyle,
                    getGoogleMapsLink,
                    // AI Exports
                    showAIModal, aiTab, apiKey, tempApiKey, saveApiKey, analyzeItinerary, aiLoading, aiResponse, parsedAiResponse,
                    thaiInput, translateToThai, thaiResult, playAudio,
                    // Smart Planner Exports
                    smartPlanInput, smartPlanScope, smartPlanAction, generateItineraryFromText
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
